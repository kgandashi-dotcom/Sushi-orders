<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×”×–×× ×ª ×¨×•×œ×™× â€” SUSHI</title>

  <!-- Supabase client (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- jwt-decode -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

  <style>
    :root{
      --accent:#7a2a2a;
      --accent-dark:#5e1b1b;
      --muted:#f0f0f0;
      --danger:#d9534f;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(180deg,#f6f5f4, #efecec);
      direction: rtl;
      color:#222;
    }

    .container{
      max-width:1020px;
      margin:18px auto;
      padding:18px;
      background: rgba(255,255,255,0.95);
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.12);
    }

    header{
      display:flex;
      flex-direction: column;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
      text-align: center;
     }
    .logo{ width:70px; height:auto; border-radius:8px; }
    h1{ margin:0; color:var(--accent); font-size:1.5rem; flex:1; }
    .user-buttons{ display:flex; gap:6px; align-items:center; }

    .tabs{
      display:flex;
      gap:6px;
      overflow-x:auto;
      margin-bottom:12px;
      flex-wrap: nowrap;
    }
    .tab-btn{
      padding:6px 12px;
      border:none;
      background:var(--muted);
      border-radius:6px;
      cursor:pointer;
      white-space:nowrap;
      flex-shrink: 0;
    }
    .tab-btn.active{ background:var(--accent); color:#fff; }

    .category-title{
      font-weight:700;
      color:var(--accent);
      margin:18px 0 8px 0;
      padding-bottom:6px;
      border-bottom:2px solid rgba(122,42,42,0.12);
    }

    .category-container{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .roll-card{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:12px;
      border-radius:10px;
      background:#fff;
      box-shadow:0 3px 8px rgba(0,0,0,0.06);
    }

    .roll-card .info{
      flex:1 1 auto;
    }
    .roll-card h3{ margin:0 0 6px 0; color:var(--accent); font-size:1.05rem;}
    .roll-card p{ margin:0; color:#444; font-size:0.93rem; }

    .quantity-control{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .quantity-control button{
      width:38px; height:36px;
      border-radius:8px;
      border:none;
      background:#f0c0c0;
      color:var(--accent);
      font-weight:700;
      font-size:1.2rem;
      cursor:pointer;
    }
    .quantity-control button:active{ transform:translateY(1px); }
    .quantity-control input{
      width:52px;
      text-align:center;
      border:1px solid #ddd;
      border-radius:6px;
      padding:6px;
      background:#fff;
    }

    .note{ color:#6b6b6b; margin:6px 0 0 0; font-size:0.92rem; }
    .small{ font-size:0.86rem; color:#8a8a8a; }

    #notes{
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:6px;
      font-family: inherit;
      resize:vertical;
      min-height:70px;
    }

    #pickup-time{
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:1rem;
    }

    #order-summary{
      background:#fff;
      padding:12px;
      border-radius:8px;
      min-height:110px;
      white-space:pre-wrap;
      font-family: "Courier New", monospace;
      margin-top:12px;
      box-shadow:0 3px 8px rgba(0,0,0,0.06);
    }

    #send-order{
      margin-top:12px;
      padding:12px 18px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:8px;
      font-size:1.05rem;
      cursor:pointer;
      width:100%;
    }
    #send-order:disabled{ background:#bbb; cursor:not-allowed; }

    #messages{
      margin-top:12px;
      color:var(--danger);
      font-weight:700;
    }

    .profile-panel{
      background:#fff;
      border-radius:8px;
      padding:12px;
      margin-top:12px;
      box-shadow:0 3px 8px rgba(0,0,0,0.06);
    }
    #order-history .history-item{
      border-top:1px dashed #ddd;
      padding:8px 0;
    }

    .user-buttons button{
      padding:8px 14px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      font-weight:600;
    }

    @media (max-width:720px){
      header{ flex-direction:column; align-items:flex-start; }
      .roll-card{ flex-direction:column; align-items:flex-start; }
      .quantity-control{ margin-top:8px; }
      .container{ padding:12px; }
    }
  </style>
</head>
<body>
  <div class="container">

    <header>
      <img src="https://i.imgur.com/m6KeXAB.jpeg" alt="×œ×•×’×•" class="logo">
      <h1>×ª×¤×¨×™×˜ ×¨×•×œ×™× â€” SUSHI</h1>
      <div class="user-buttons">
        <div id="login-btn"></div>
        <button id="profile-btn" style="display:none;">×¤×¨×•×¤×™×œ</button>
        <button id="logout-btn" style="display:none;">×”×ª× ×ª×§×•×ª</button>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-target="insideout">Inside-out</button>
      <button class="tab-btn" data-target="maki">Maki</button>
      <button class="tab-btn" data-target="onigiri">Onigiri</button>
      <button class="tab-btn" data-target="oshizushi">Oshizushi</button>
      <button class="tab-btn" data-target="poke">Poke</button>
      <button class="tab-btn" data-target="sauces">×¨×˜×‘×™×</button>
    </nav>

    <main>
      <section id="menu-section">
        <div id="insideout" class="menu-category">
          <div class="category-title">Inside-out Rolls</div>
          <div id="insideout-rolls" class="category-container"></div>
        </div>

        <div id="maki" class="menu-category" style="display:none">
          <div class="category-title">Maki Rolls</div>
          <div id="maki-rolls" class="category-container"></div>
        </div>

        <div id="onigiri" class="menu-category" style="display:none">
          <div class="category-title">Onigiri</div>
          <div id="onigiri-rolls" class="category-container"></div>
        </div>

        <div id="oshizushi" class="menu-category" style="display:none">
          <div class="category-title">Oshizushi</div>
          <div id="oshizushi-rolls" class="category-container"></div>
        </div>

        <div id="poke" class="menu-category" style="display:none">
          <div class="category-title">Poke</div>
          <div id="poke-rolls" class="category-container"></div>
        </div>

        <div id="sauces" class="menu-category" style="display:none">
          <div class="category-title">×¨×˜×‘×™×</div>
          <div id="sauces-container" class="category-container"></div>
          <p class="note">×›×œ ×¨×•×œ ××§×‘×œ 2 ×¨×˜×‘×™× ×—×™× ×. ×¨×•×˜×‘ × ×•×¡×£ ×¢×•×œ×” 3â‚ª.</p>
        </div>
      </section>

      <section id="chopsticks">
        <div class="category-title">×›××•×ª ×¦'×•×¤×¡×˜×™×§×¡</div>
        <div class="quantity-control">
          <button id="chopsticks-minus">âˆ’</button>
          <input id="chopsticks-qty" type="number" readonly value="1">
          <button id="chopsticks-plus">+</button>
        </div>
      </section>

      <section id="notes-section">
        <div class="category-title">×”×¢×¨×•×ª ××™×©×™×•×ª</div>
        <textarea id="notes" placeholder="×”×¢×¨×•×ª ×œ××©×œ: ×œ×œ× ×’×œ×•×˜×Ÿ, ×”×’×¢×” ×‘×©×¢×¨ 3..."></textarea>
      </section>

      <section id="pickup-section">
        <div class="category-title">×‘×—×¨ ×©×¢×ª ××™×¡×•×£</div>
        <select id="pickup-time">
          <option value="">×‘×—×¨ ×©×¢×”</option>
        </select>
        <p class="note small" id="pickup-note">×”×©×¢×•×ª ×”×–××™× ×•×ª ××ª×¢×“×›× ×•×ª ×‘×”×ª×× ×œ×”×–×× ×•×ª ×§×™×™××•×ª</p>
      </section>

      <section id="summary-section">
        <div class="category-title">×¡×™×›×•× ×”×–×× ×”</div>
        <pre id="order-summary">×”×–×× ×” ×¨×™×§×” â€” ×‘×—×¨ ×¨×•×œ×™×, ×¨×˜×‘×™× ×•×©×¢×” ×œ×”×¦×’×ª ×”×¡×™×›×•×.</pre>
        <button id="send-order">×©×œ×— ×”×–×× ×”</button>
      </section>

      <div id="messages" aria-live="polite"></div>

      <section id="profile-panel" class="profile-panel" style="display:none;">
        <h3>×¤×¨×•×¤×™×œ</h3>
        <div id="profile-info"></div>
        <h4>×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª</h4>
        <div id="order-history"></div>
      </section>

    </main>

  </div>

  <script>

    // ========================================
    // ×”×’×“×¨×•×ª ×¨××©×•× ×™×•×ª
    // ========================================
    
    // ×”×’×“×¨×ª Supabase
 const SUPABASE_URL = 'https://oxjokdjwdvmmdtcvqvon.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9rZGp3ZHZtbWR0Y3Zxdm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzgwMzMsImV4cCI6MjA3NDY1NDAzM30.DmKp79UiPi9iOU50UutevdqRcPyREMUJ7NT5ZmBHDsg';

let supabase = null;

// ×”××ª×Ÿ ×œ×˜×¢×™× ×ª Supabase ×•××– ×¦×•×¨ ×—×™×‘×•×¨
if (typeof window.supabase !== 'undefined') {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('âœ… Supabase ××—×•×‘×¨ ×‘×”×¦×œ×—×”!');
} else {
  console.error('âŒ Supabase ×œ× × ×˜×¢×Ÿ - ×‘×“×•×§ ××ª ×”×¡×§×¨×™×¤×˜');
}

const GOOGLE_CLIENT_ID = "962297663657-7bsrugivo5rjbu534lamiuc256gbqoc4.apps.googleusercontent.com";
const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/asitqrbtyjum10ph3vf6gxhkd766us3r";

// ××™××™×™×œ ×× ×”×œ (×œ××™×¤×•×¡)
const ADMIN_EMAIL = 'kgandashi@gmail.com';

// ×–××Ÿ ×”×›× ×” ×œ×¨×•×œ (×‘×“×§×•×ª)
const PREP_TIME_PER_ROLL = 10;
    // ========================================
    // ×ª×¤×¨×™×˜ - × ×ª×•× ×™×
    // ========================================

    const menuData = {
      insideout: [
        {name: '×¨×•×œ ×‘×™× ×’×•', desc: '×¡×œ××•×Ÿ × ×, ×©×× ×ª, ××‘×•×§×“×• ×‘×¦×™×¤×•×™ ×©×•××©×•× ×§×œ×•×™', price: 50},
        {name: '×¨×•×œ ×œ×•× ×”', desc: '×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ××¤×•×™ ×¢×œ ×¨×•×œ ×‘×˜×˜×”, ××‘×•×§×“×• ×•×©×™×˜××§×™', price: 50},
        {name: '×¨×•×œ ×¨×™×™', desc: '×˜×¨×˜×¨ ×¡×¤×™×™×¡×™ ×˜×•× ×” × × ×¢×œ ×¨×•×œ ××œ×¤×¤×•×Ÿ, ×¢×™×¨×™×ª ×•××•×©×™× ×§×•', price: 55},
        {name: '×¨×•×œ ×§×¨×™×™×–×™ ×‘×¨×•× ×•', desc: '×“×’ ×œ×‘×Ÿ, ×˜×•× ×”, ×¡×œ××•×Ÿ ×‘×¦×™×¤×•×™ ×©×•××©×•× ×§×œ×•×™', price: 60},
        {name: '×¨×•×œ ×”××¤×™ ×‘×¨×•× ×•', desc: '×¡×œ××•×Ÿ ×‘×¦×™×¤×•×™ ×©×§×“×™× ×§×œ×•×™×™× ×•×¨×•×˜×‘ ×˜×¨×™××§×™', price: 60},
        {name: '×¨×•×œ ××™×œ×”', desc: '×‘×˜×˜×”, ×¢×™×¨×™×ª ×•××‘×•×§×“×• ×‘×¢×™×˜×•×£ ×¡×œ××•×Ÿ ×¦×¨×•×‘', price: 50},
        {name: '×¨×•×œ × ×™×•×˜×•×Ÿ', desc: '×˜×•× ×” ××“×•××”, ××‘×•×§×“×•, ×‘×˜×˜×” ×‘×¦×™×¤×•×™ ×¤× ×§×• ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 55},
        {name: '×¨×•×œ ××•×œ×™', desc: '×“×’ ×œ×‘×Ÿ, ××œ×¤×¤×•×Ÿ, ××‘×•×§×“×• ×‘×¦×™×¤×•×™ ×©×•××©×•×', price: 50},
        {name: '×¨×•×œ ××™×œ×™', desc: '××§×œ ×¡×•×¨×™××™, ×“×’ ×œ×‘×Ÿ ××¤×•×™, ××•×©×™× ×§×• ×‘×¦×™×¤×•×™ ×¤× ×§×•', price: 50},
        {name: '×¨×•×œ ×¡×§××¨', desc: '×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ××¤×•×™ ×¢× ××‘×•×§×“×•, ××œ×¤×¤×•×Ÿ ×•×‘×˜×˜×” ×‘×¢×™×˜×•×¨ ××™×•× ×– ×•×¦\'×™×¤×¡', price: 50},
        {name: '×¨×•×œ ××’×™ ğŸŒ±', desc: '××œ×¤×¤×•×Ÿ, ×‘×˜×˜×”, ×¢×™×¨×™×ª ×•××‘×•×§×“×• ×‘×¢×™×˜×•×¨ ×‘×˜×˜×” ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 40},
        {name: '×¨×•×œ ×˜×™×™×¡×•×Ÿ ×•×§×™×™×œ×”', desc: '×¡×œ××•×Ÿ × ×, ×§× ×¤×™×•, ×‘×˜×˜×” ×‘×¢×™×˜×•×£ ×©×‘×‘×™ ×¤× ×§×• ×¡×’×•×œ', price: 50},
        {name: '×¨×•×œ ×œ×•×¡×™', desc: '×¡×œ××•×Ÿ × ×, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™ ×•××•×©×™× ×§×• ×‘×¦×™×¤×•×™ ×˜×•×‘×™×§×•', price: 55},
        {name: '×¨×•×œ ×‘×™×œ×™', desc: '×“×’ ×œ×‘×Ÿ ×¦×¨×•×‘, ×¢×™×¨×™×ª, ×‘×˜×˜×” ××¦×•×¤×” ×‘×¤× ×§×•', price: 50},
        {name: '×¨×•×œ ×œ××§×™', desc: '×˜×¨×˜×¨ ×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ×¢× ××‘×•×§×“×•, ××œ×¤×¤×•×Ÿ ×•×¢×™×¨×™×ª', price: 50}
      ],
      
      maki: [
        {name: '×¨×•×œ ××œ×¤×™', desc: '×××§×™ ×¡×œ××•×Ÿ', price: 35},
        {name: '×¨×•×œ ××™×™ ××™×™ ğŸŒ±', desc: '×××§×™ ×‘×˜×˜×” ×•××‘×•×§×“×•', price: 25},
        {name: '×¨×•×œ ×¡× ×•×¤×™ ğŸŒ±', desc: '×××§×™ ××•×©×™× ×§×• ×•×§× ×¤×™×•', price: 25}
      ],
      
      onigiri: [
        {name: '××•× ×™×’×™×¨×™ ×¨×•×§×™', desc: '×˜×¨×˜×¨ ×˜×•× ×” ××“×•××” ×¢× ×¡×¤×™×™×¡×™ ××™×•× ×– ×•×‘×¦×œ ×™×¨×•×§', price: 35},
        {name: '××•× ×™×’×™×¨×™ ×’\'×•× ×™', desc: '×˜×¨×˜×¨ ×¡×œ××•×Ÿ ×¢× ×¡×¤×™×™×¡×™ ××™×•× ×– ×•×‘×¦×œ ×™×¨×•×§', price: 30},
        {name: '××•× ×™×’×™×¨×™ ×’\'×™×–×œ ğŸŒ±', desc: '××‘×•×§×“×• ×•×‘×˜×˜×”', price: 25}
      ],
      
      oshizushi: [
        {name: '××•×©×™×–×•×©×™ ×¡×œ××•×Ÿ ×§×œ××¡×™', desc: '6 ×™×—\' - ×¡×œ××•×Ÿ ×˜×¨×™ ×œ×—×•×¥ ×¢×œ ××•×¨×– ×¡×•×©×™', price: 42},
        {name: '××•×©×™×–×•×©×™ ×˜×•× ×” ×¤×™×§× ×˜×™', desc: '6 ×™×—\' - ×˜×•× ×” ×‘××¨×™× ×“×” ×—×¨×™×¤×” ×¢×œ ××•×¨×–', price: 45},
        {name: '××•×©×™×–×•×©×™ ×¦××—×•× ×™ ğŸŒ±', desc: '6 ×™×—\' - ××‘×•×§×“×• ×•×‘×˜×˜×” ×œ×—×•×¦×™× ×¢×œ ××•×¨×–', price: 35}
      ],
      
      poke: [
        {name: '×‘×•×œ-×“×•×’', desc: '××•×¨×– ×¡×•×©×™, ×¡×œ××•×Ÿ ×‘××¨×™× ×“×”, ××“×××”, ××œ×¤×¤×•×Ÿ, ××‘×•×§×“×•, ×‘×¦×œ ×™×¨×•×§. ××¢×œ ×©×•××©×•× ×•×¨×•×˜×‘ ×¡×¤×™×™×¡×™ ××™×•× ×–', price: 60},
        {name: '×¤×™×˜-×‘×•×œ', desc: '××•×¨×– ×¡×•×©×™, ×˜×•× ×” ×‘××¨×™× ×“×”, ××“×××”, ×× ×’×•, ×›×¨×•×‘ ×¡×’×•×œ, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™. ××¢×œ ×‘×¦×œ ×©××œ×•×˜ ××˜×•×’×Ÿ ×•×¨×•×˜×‘ ×× × ×¡ ××ª×•×§', price: 70},
        {name: '×‘×•×œ-×˜×¨×™×™×¨ ğŸŒ±', desc: '××•×¨×– ×¡×•×©×™, ××“×××”, ××œ×¤×¤×•×Ÿ, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™, ×’×–×¨ ×•××‘×•×§×“×•. ××¢×œ ×©×•××©×•× ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 45}
      ],
      
      sauces: [
        {name: '×¡×¤×™×™×¡×™ ××™×•× ×–', price: 0},
        {name: '×¨×•×˜×‘ ×¡×•×™×”', price: 0},
        {name: '×¨×•×˜×‘ ×˜×¨×™××§×™', price: 0},
        {name: '×’\'×™× ×’\'×¨', price: 0},
        {name: '×•×•××¡×‘×™', price: 0}
      ]
    };

    // ========================================
    // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
    // ========================================

    let currentUser = null;
    let orderItems = {};
    let sauceSelections = {};
    let chopsticksCount = 1;
    let existingOrders = [];

    // ========================================
    // ××ª×—×•×œ
    // ========================================

    document.addEventListener('DOMContentLoaded', () => {
      initGoogleAuth();
      checkLocalAuth();
      renderMenu();
      setupTabs();
      setupChopsticks();
      loadExistingOrders();
      setupSendOrder();
      setupProfileButton();
      setupLogoutButton();
      updateSummary();
    });

    // ========================================
    // Google OAuth
    // ========================================

  function initGoogleAuth() {
  if (!window.google?.accounts?.id) {
    console.log('Google OAuth ×œ× × ×˜×¢×Ÿ ×¢×“×™×™×Ÿ');
    setTimeout(initGoogleAuth, 500);
    return;
  }
  window.google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleGoogleLogin
  });
  window.google.accounts.id.renderButton(
    document.getElementById('login-btn'),
    { theme: 'outline', size: 'large', text: 'signin_with', locale: 'he' }
  );
}

    async function handleGoogleLogin(response) {
      try {
        const decoded = jwt_decode(response.credential);
        currentUser = {
          name: decoded.name,
          email: decoded.email,
          phone: prompt('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ:') || ''
        };
        localStorage.setItem('sushiUser', JSON.stringify(currentUser));
        showMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”!', 'green');
        updateUIAfterLogin();
      } catch (err) {
        showMessage('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + err.message, 'red');
      }
    }

    function checkLocalAuth() {
      const stored = localStorage.getItem('sushiUser');
      if (stored) {
        currentUser = JSON.parse(stored);
        updateUIAfterLogin();
      }
    }

    function updateUIAfterLogin() {
      document.getElementById('login-btn').style.display = 'none';
      document.getElementById('profile-btn').style.display = 'inline-block';
      document.getElementById('logout-btn').style.display = 'inline-block';
    }

    // ========================================
    // ×¤×¨×•×¤×™×œ
    // ========================================

    function setupProfileButton() {
      document.getElementById('profile-btn').addEventListener('click', () => {
        const panel = document.getElementById('profile-panel');
        if (panel.style.display === 'none') {
          showProfile();
          panel.style.display = 'block';
        } else {
          panel.style.display = 'none';
        }
      });
    }

    async function showProfile() {
      const info = document.getElementById('profile-info');
      info.innerHTML = `
        <p><strong>×©×:</strong> ${currentUser.name}</p>
        <p><strong>××™××™×™×œ:</strong> ${currentUser.email}</p>
        <p><strong>×˜×œ×¤×•×Ÿ:</strong> ${currentUser.phone} 
          <button onclick="editPhone()">×¢×¨×•×š</button>
        </p>
      `;
      await loadOrderHistory();
    }

    async function loadOrderHistory() {
      try {
        const { data, error } = await supabase
          .from('Sushi')
          .select('*')
          .eq('email', currentUser.email)
          .order('created_at', { ascending: false });

        if (error) throw error;

        const historyDiv = document.getElementById('order-history');
        if (!data || data.length === 0) {
          historyDiv.innerHTML = '<p>××™×Ÿ ×”×–×× ×•×ª ×§×•×“××•×ª.</p>';
          return;
        }

        historyDiv.innerHTML = data.map(order => `
          <div class="history-item">
            <strong>${new Date(order.created_at).toLocaleDateString('he-IL')}</strong><br>
            ×©×¢×ª ××™×¡×•×£: ${order.pickup_time}<br>
            ×¡×”"×›: ${order.total_price}â‚ª
          </div>
        `).join('');
      } catch (err) {
        showMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”: ' + err.message, 'red');
      }
    }

    window.editPhone = function() {
      const newPhone = prompt('×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×“×©:', currentUser.phone);
      if (newPhone) {
        currentUser.phone = newPhone;
        localStorage.setItem('sushiUser', JSON.stringify(currentUser));
        showProfile();
      }
    };

    // ========================================
    // ×”×ª× ×ª×§×•×ª
    // ========================================

    function setupLogoutButton() {
      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('sushiUser');
        currentUser = null;
        document.getElementById('login-btn').style.display = 'block';
        document.getElementById('profile-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('profile-panel').style.display = 'none';
        showMessage('×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”', 'green');
      });
    }

    // ========================================
    // ×¨×™× ×“×•×¨ ×ª×¤×¨×™×˜
    // ========================================

    function renderMenu() {
      renderCategory('insideout', 'insideout-rolls');
      renderCategory('maki', 'maki-rolls');
      renderCategory('onigiri', 'onigiri-rolls');
      renderCategory('oshizushi', 'oshizushi-rolls');
      renderCategory('poke', 'poke-rolls');
      renderSauces();
    }

    function renderCategory(category, containerId) {
      const container = document.getElementById(containerId);
      const items = menuData[category];
      
      container.innerHTML = items.map((item, idx) => {
        const key = `${category}_${idx}`;
        return `
          <div class="roll-card">
            <div class="info">
              <h3>${item.name}</h3>
              <p>${item.desc}</p>
              <p><strong>${item.price}â‚ª</strong></p>
            </div>
            <div class="quantity-control">
              <button onclick="changeQty('${key}', -1)">âˆ’</button>
              <input type="number" id="${key}" value="0" readonly>
              <button onclick="changeQty('${key}', 1)">+</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderSauces() {
      const container = document.getElementById('sauces-container');
      container.innerHTML = menuData.sauces.map((sauce, idx) => {
        const key = `sauce_${idx}`;
        return `
          <div class="roll-card">
            <div class="info">
              <h3>${sauce.name}</h3>
            </div>
            <div class="quantity-control">
              <button onclick="changeSauce('${key}', -1)">âˆ’</button>
              <input type="number" id="${key}" value="0" readonly>
              <button onclick="changeSauce('${key}', 1)">+</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========================================
    // ×œ×©×•× ×™×•×ª (Tabs)
    // ========================================

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          document.querySelectorAll('.menu-category').forEach(cat => {
            cat.style.display = 'none';
          });

          const target = tab.getAttribute('data-target');
          document.getElementById(target).style.display = 'block';
        });
      });
    }

    // ========================================
    // ×›××•×™×•×ª ×¨×•×œ×™×
    // ========================================

    window.changeQty = function(key, delta) {
      const input = document.getElementById(key);
      let val = parseInt(input.value) || 0;
      val = Math.max(0, val + delta);
      input.value = val;
      
      if (val > 0) {
        orderItems[key] = val;
      } else {
        delete orderItems[key];
      }
      
      updateSummary();
    };

    // ========================================
    // ×¨×˜×‘×™×
    // ========================================

    window.changeSauce = function(key, delta) {
      const input = document.getElementById(key);
      let val = parseInt(input.value) || 0;
      val = Math.max(0, val + delta);
      input.value = val;
      
      if (val > 0) {
        sauceSelections[key] = val;
      } else {
        delete sauceSelections[key];
      }
      
      updateSummary();
    };

    // ========================================
    // ×¦'×•×¤×¡×˜×™×§×¡
    // ========================================

    function setupChopsticks() {
      document.getElementById('chopsticks-minus').addEventListener('click', () => {
        if (chopsticksCount > 0) {
          chopsticksCount--;
          document.getElementById('chopsticks-qty').value = chopsticksCount;
          updateSummary();
        }
      });

      document.getElementById('chopsticks-plus').addEventListener('click', () => {
        chopsticksCount++;
        document.getElementById('chopsticks-qty').value = chopsticksCount;
        updateSummary();
      });
    }

    // ========================================
    // ×˜×¢×™× ×ª ×”×–×× ×•×ª ×§×™×™××•×ª ×-Supabase
    // ========================================

    async function loadExistingOrders() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const { data, error } = await supabase
          .from('Sushi')
          .select('pickup_time, total_rolls')
          .eq('order_date', today);

        if (error) throw error;

        existingOrders = data || [];
        generatePickupSlots();
      } catch (err) {
        console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×–×× ×•×ª:', err);
        generatePickupSlots();
      }
    }

    // ========================================
    // ×™×¦×™×¨×ª ×©×¢×•×ª ××™×¡×•×£ ×—×›××•×ª
    // ========================================

    function generatePickupSlots() {
      const select = document.getElementById('pickup-time');
      select.innerHTML = '<option value="">×‘×—×¨ ×©×¢×”</option>';

      const start = 19 * 60; // 19:00
      const end = 22.5 * 60; // 22:30
      const blockedTimes = new Set();

      // ×—×™×©×•×‘ ×©×¢×•×ª ×—×¡×•××•×ª ×¢×œ ×‘×¡×™×¡ ×”×–×× ×•×ª ×§×™×™××•×ª
      existingOrders.forEach(order => {
        const [hours, minutes] = order.pickup_time.split(':').map(Number);
        const orderTimeInMinutes = hours * 60 + minutes;
        
        // ×›×œ ×”×–×× ×” ×—×•×¡××ª ××ª ×”×©×¢×” ×©×œ×” + 10 ×“×§×•×ª ×œ×¤× ×™×”
        blockedTimes.add(orderTimeInMinutes);
        blockedTimes.add(orderTimeInMinutes - 10);
        blockedTimes.add(orderTimeInMinutes - 20);
        blockedTimes.add(orderTimeInMinutes - 30);
      });

      // ×™×¦×™×¨×ª ××•×¤×¦×™×•×ª ×–××™× ×•×ª
      for (let minutes = start; minutes <= end; minutes += 30) {
        if (!blockedTimes.has(minutes)) {
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          const timeStr = `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}`;
          const option = document.createElement('option');
          option.value = timeStr;
          option.textContent = timeStr;
          select.appendChild(option);
        }
      }

      select.addEventListener('change', updateSummary);
    }

    // ========================================
    // ×¡×™×›×•× ×”×–×× ×”
    // ========================================

    function updateSummary() {
      let totalRolls = 0;
      let totalPrice = 0;
      let lines = [];

      // ×¨×•×œ×™×
      Object.keys(orderItems).forEach(key => {
        const qty = orderItems[key];
        totalRolls += qty;
        
        const [category, idx] = key.split('_');
        const item = menuData[category][parseInt(idx)];
        const itemTotal = item.price * qty;
        totalPrice += itemTotal;
        
        lines.push(`${item.name} x${qty} = ${itemTotal}â‚ª`);
      });

      // ×¨×˜×‘×™×
      const totalSauces = Object.values(sauceSelections).reduce((a,b) => a+b, 0);
      const freeSauces = totalRolls * 2;
      const extraSauces = Math.max(0, totalSauces - freeSauces);
      const saucePrice = extraSauces * 3;
      totalPrice += saucePrice;

      if (totalSauces > 0) {
        lines.push(`\n×¨×˜×‘×™×: ${totalSauces} (${freeSauces} ×—×™× ×, ${extraSauces} ×‘×ª×©×œ×•×) = ${saucePrice}â‚ª`);
      }

      // ×¦'×•×¤×¡×˜×™×§×¡
      lines.push(`×¦'×•×¤×¡×˜×™×§×¡: ${chopsticksCount}`);

      // ×”×¢×¨×•×ª
      const notes = document.getElementById('notes').value.trim();
      if (notes) {
        lines.push(`\n×”×¢×¨×•×ª: ${notes}`);
      }

      // ×©×¢×ª ××™×¡×•×£
      const pickupTime = document.getElementById('pickup-time').value;
      if (pickupTime) {
        lines.push(`\n×©×¢×ª ××™×¡×•×£: ${pickupTime}`);
      }

      lines.push(`\n${'='.repeat(30)}\n×¡×”"×› ×œ×ª×©×œ×•×: ${totalPrice}â‚ª`);

      document.getElementById('order-summary').textContent = 
        totalRolls > 0 ? lines.join('\n') : '×”×–×× ×” ×¨×™×§×” â€” ×‘×—×¨ ×¨×•×œ×™×, ×¨×˜×‘×™× ×•×©×¢×” ×œ×”×¦×’×ª ×”×¡×™×›×•×.';

      // ×‘×“×™×§×ª ××’×‘×œ×•×ª
      const sendBtn = document.getElementById('send-order');
      if (totalRolls === 0 || !pickupTime) {
  sendBtn.disabled = true;
      } else if (totalRolls > 15) {
        sendBtn.disabled = true;
        showMessage('×œ× × ×™×ª×Ÿ ×œ×”×–××™×Ÿ ×™×•×ª×¨ ×Ö¾15 ×¨×•×œ×™× ×‘×™×•×', 'red');
      } else {
        sendBtn.disabled = false;
        document.getElementById('messages').textContent = '';
      }
    }

    // ========================================
    // ×©×œ×™×—×ª ×”×–×× ×”
    // ========================================

function setupSendOrder() {
  document.getElementById('send-order').addEventListener('click', async () => {
    let orderUser = currentUser;
    
    if (!currentUser) {
      // ×”×–×× ×” ×›××•×¨×—
      const guestName = prompt('×©× ××œ×:');
      if (!guestName) return;
      
      const guestPhone = prompt('××¡×¤×¨ ×˜×œ×¤×•×Ÿ:');
      if (!guestPhone) return;
      
      const guestEmail = prompt('××™××™×™×œ (××•×¤×¦×™×•× ×œ×™):') || `guest_${Date.now()}@temp.com`;
      
      orderUser = {
        name: guestName,
        phone: guestPhone,
        email: guestEmail
      };
    }

        const pickupTime = document.getElementById('pickup-time').value;
        if (!pickupTime) {
          showMessage('× × ×œ×‘×—×•×¨ ×©×¢×ª ××™×¡×•×£', 'red');
          return;
        }

        const totalRolls = Object.values(orderItems).reduce((a,b) => a+b, 0);
        if (totalRolls === 0) {
          showMessage('×¢×œ×™×š ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×¨×•×œ ××—×“', 'red');
          return;
        }

        if (totalRolls > 15) {
          showMessage('×œ× × ×™×ª×Ÿ ×œ×”×–××™×Ÿ ×™×•×ª×¨ ×Ö¾15 ×¨×•×œ×™× ×‘×™×•×', 'red');
          return;
        }

        try {
          // ×—×™×©×•×‘ ××—×™×¨
          const totalSauces = Object.values(sauceSelections).reduce((a,b) => a+b, 0);
          const freeSauces = totalRolls * 2;
          const extraSauces = Math.max(0, totalSauces - freeSauces);
          
          let totalPrice = 0;
          Object.keys(orderItems).forEach(key => {
            const [category, idx] = key.split('_');
            const item = menuData[category][parseInt(idx)];
            totalPrice += item.price * orderItems[key];
          });
          totalPrice += extraSauces * 3;

const orderData = {
  user_name: orderUser.name,
  email: orderUser.email,
  phone: orderUser.phone,
            order_date: new Date().toISOString().split('T')[0],
            pickup_time: pickupTime,
            items: JSON.stringify(orderItems),
            sauces: JSON.stringify(sauceSelections),
            chopsticks: chopsticksCount,
            notes: document.getElementById('notes').value,
            total_price: totalPrice,
            total_rolls: totalRolls
          };

          // ×©××™×¨×” ×‘-Supabase
          if (!supabase) {
  showMessage('Supabase ×œ× ××—×•×‘×¨ - ×‘×“×•×§ ××ª ×”×”×’×“×¨×•×ª', 'red');
  return;
}

const { error: dbError } = await supabase
  .from('Sushi')
  .insert([orderData]);

if (dbError) throw dbError;

          // ×©×œ×™×—×” ×œ-Make.com
          await fetch(MAKE_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
          });

          showMessage('âœ… ×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!', 'green');
          
          // ××™×¤×•×¡ ×˜×•×¤×¡
          resetOrder();
          
          // ×¨×¢× ×•×Ÿ ×©×¢×•×ª
          await loadExistingOrders();

        } catch (err) {
          showMessage('âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×”: ' + err.message, 'red');
        }
      });
    }

    // ========================================
    // ××™×¤×•×¡ ×”×–×× ×”
    // ========================================

    function resetOrder() {
      orderItems = {};
      sauceSelections = {};
      chopsticksCount = 1;
      
      document.querySelectorAll('.quantity-control input').forEach(input => {
        input.value = 0;
      });
      
      document.getElementById('chopsticks-qty').value = 1;
      document.getElementById('notes').value = '';
      document.getElementById('pickup-time').value = '';
      
      updateSummary();
    }

    // ========================================
    // ×”×•×“×¢×•×ª ×œ××©×ª××©
    // ========================================

    function showMessage(text, color) {
      const msgDiv = document.getElementById('messages');
      msgDiv.textContent = text;
      msgDiv.style.color = color;
      
      setTimeout(() => {
        msgDiv.textContent = '';
      }, 5000);
    }

  </script>

</body>
</html>
