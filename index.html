<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sushi Shifu</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

  <style>
    /* ×”×’×“×¨×•×ª ××™×¤×•×¡ ×‘×¡×™×¡×™×•×ª */
    * {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      box-sizing: border-box;
    }

    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
    }

    :root {
      --accent: #cb7e3d;
      --accent-dark: #5e1b1b;
      --muted: #3a3a3a;
      --danger: #d9534f;
      --bg-dark: #1a1a1a;
      --text-color: #f0f0f0;
    }
 
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(180deg, #1f1a1a, #0d0d0d);
      direction: rtl;
      color: var(--accent);
      font-size: 16px;
    }

    /* ×ª×™×§×•×Ÿ: ×”×•×¡×¤×ª ×”× ×§×•×“×” ×œ×§×œ××¡ container */
    .container {
      max-width: 1020px;
      margin: 9px auto;
      padding: 9px;
      background: #1a1a1a;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(255,255,255,0.1);
      min-height: 100vh;
      padding-bottom: 100px;
    }
    
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; 
      padding: 10px 20px;
      position: relative;
      margin-bottom: 10px;
    }

    .logo {
      height: 120px;
      width: auto;
      border-radius: 8px;
      display: block;
      margin-bottom: 10px;
    }

    .user-buttons {
      display: flex;
      gap: 6px;
      align-items: center;
      position: absolute;
      top: 10px;
      left: 10px; /* ×¦×“ ×©×××œ */
    }

    h1 {
      margin: 5px 0;
      font-size: 1.5rem;
      text-align: center;
      width: 100%;
      color: #f5f5f5;
    }

    /* --- ×ª×™×§×•×Ÿ ×”×˜××‘×™× (Tabs) --- */
    /* ×›××Ÿ ×”×©×™× ×•×™ ×”×’×“×•×œ: flex-wrap: wrap ×’×•×¨× ×œ×”× ×œ×¨×“×ª ×©×•×¨×” ×‘××§×•× ×œ×’×œ×•×œ */
    .tabs {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #1a1a1a; /* ×¨×§×¢ ×›×“×™ ×©×œ× ×™×”×™×” ×©×§×•×£ ×‘×’×œ×™×œ×” */
      display: flex;
      flex-wrap: wrap; /* ×–×” ××” ×©××•× ×¢ ×’×œ×™×œ×” ×•××›× ×™×¡ ×”×›×œ ×‘××¡×š */
      justify-content: center; /* ××¨×›×•×– */
      gap: 8px;
      padding: 10px 0;
      margin: 10px 0 20px 0;
      border-bottom: 1px solid #333;
    }

    .tab-btn {
      padding: 8px 12px;
      border: none;
      background: var(--muted);
      color: #b0b0b0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 400;
      flex: 1 0 auto; /* ×××¤×©×¨ ×œ×›×¤×ª×•×¨×™× ×œ×’×“×•×œ ×•×œ×ª×¤×•×¡ ××§×•× */
      text-align: center;
      transition: all 0.3s ease;
    }

    .tab-btn.active { 
      background: #cb7e3d; 
      color: #fff;
      font-weight: 700;
      box-shadow: 0 0 5px rgba(203, 126, 61, 0.4);
    }
    
    .category-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ×¢×™×¦×•×‘ ×›×¨×˜×™×¡ ×¨×•×œ - Flexbox */
    .roll-card {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      background: #252525;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      min-height: 100px;
      gap: 12px;
    }

    /* ×ª×•×›×Ÿ ×”×›×¨×˜×™×¡ (×ª××•× ×” ×•×˜×§×¡×˜) */
    .roll-card-content {
      display: flex;
      flex: 1;
      align-items: center;
      gap: 12px;
    }

    .roll-card .roll-image,
    .roll-card .roll-image-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .roll-card .roll-image-placeholder {
      background: #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .roll-card .info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .roll-card h3 {
      margin: 0;
      color: #adb745;
      font-size: 1.15rem;
    }
    .roll-card p {
      margin: 0;
      color: #f5f5f5;
      font-size: 0.9rem;
      line-height: 1.3;
    }

    /* ×›×¤×ª×•×¨×™ ×›××•×ª */
    .quantity-control {
      display: flex;
      gap: 6px;
      align-items: center;
      background: #333;
      padding: 4px;
      border-radius: 8px;
    }
    .quantity-control button {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      border: none;
      background: #ddd;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      color: #000;
    }
    .quantity-control input {
      width: 35px;
      text-align: center;
      border: none;
      background: transparent;
      color: #fff;
      font-size: 1.1rem;
      padding: 0;
    }

    /* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª ×œ××•×‘×™×™×œ */
    @media (max-width: 600px) {
      .roll-card {
        flex-direction: column;
        align-items: stretch;
      }
      .roll-card-content {
        width: 100%;
      }
      .quantity-control {
        align-self: flex-end; /* ×›×¤×ª×•×¨×™× ×‘×©×××œ ×œ××˜×” */
        margin-top: 8px;
        width: auto;
      }
    }
    
    .note {
      color: #6b6b6b;
      margin: 6px 0 0 0;
      font-size: 0.92rem;
    }

    .category-title {
        color: var(--accent);
        font-size: 1.3rem;
        margin: 20px 0 10px 0;
        font-weight: bold;
        border-bottom: 1px solid #333;
        padding-bottom: 5px;
    }

    /* ×˜×¤×¡×™× */
    #notes, #pickup-time {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2a2a2a;
      color: #adb754;
      font-size: 1rem;
      margin-top: 10px;
    }

    #order-summary {
      background: #2a2a2a;
      color: #f0f0f0;
      padding: 16px;
      border-radius: 8px;
      min-height: 110px;
      white-space: pre-wrap;
      font-family: "Courier New", monospace;
      margin-top: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    #send-order {
      margin-top: 20px;
      padding: 14px 20px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.15rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }
    #send-order:disabled { 
      background: #555; 
      cursor: not-allowed; 
      opacity: 0.7;
    }
    
    #messages {
      margin-top: 12px;
      font-weight: 700;
      text-align: center;
      min-height: 20px;
    }

    /* ×›×¤×ª×•×¨ ×¤×¨×•×¤×™×œ */
    #profile-btn {
      background: none;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    /* ××•×“××œ×™× */
    #image-modal {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* ×¤×•×¤-××¤ */
    .order-popup { position: fixed; inset: 0; z-index: 9999; font-family: sans-serif; display: flex; align-items: center; justify-content: center; }
    .order-popup__backdrop { position:absolute; inset:0; background: rgba(0,0,0,0.85); backdrop-filter: blur(2px); }
    .order-popup__box {
      position: relative;
      width: 90%;
      max-width: 400px;
      background: #fff;
      color: #111;
      border-radius: 10px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .order-popup__ok {
      background: #cb7e3d;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 15px;
    }
  </style>
</head>
<body>

<div class="container">
  
  <div id="phone-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:30px; border-radius:12px; max-width:400px; width:90%; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.5); border: 1px solid #444;">
      <h3 style="color:#cb7e3d; margin:0 0 10px 0; font-size:1.3rem;">×”×•×“×¢×” ×-Shifu</h3>
      <p style="color:#b0b0b0; margin:0 0 20px 0; font-size:1rem;">× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×‘×¤×•×¨××˜: 05X-XXXXXXX</p>
      <input type="tel" id="phone-input" placeholder="050-1234567" style="width:100%; padding:12px; border:1px solid #444; border-radius:6px; background:#2a2a2a; color:#f0f0f0; font-size:1.1rem; text-align:center; direction:ltr;">
      <div style="margin-top:20px; display:flex; gap:10px;">
        <button onclick="submitPhone()" style="flex:1; padding:12px; background:#cb7e3d; color:#fff; border:none; border-radius:6px; font-size:1rem; font-weight:600; cursor:pointer;">××™×©×•×¨</button>
        <button onclick="cancelPhone()" style="flex:1; padding:12px; background:#3a3a3a; color:#b0b0b0; border:none; border-radius:6px; font-size:1rem; font-weight:600; cursor:pointer;">×‘×™×˜×•×œ</button>
      </div>
      <p id="phone-error" style="color:#d9534f; margin:15px 0 0 0; font-size:0.9rem; display:none;"></p>
    </div>
  </div>

  <div id="image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center; cursor:pointer;" onclick="closeImageModal()">
    <div style="position:relative; max-width:90%; max-height:90%; display:flex; align-items:center; justify-content:center;">
      <button onclick="closeImageModal(); event.stopPropagation();" style="position:absolute; top:-50px; right:0; background:#cb7e3d; color:#fff; border:none; border-radius:50%; width:40px; height:40px; font-size:1.5rem; cursor:pointer;">Ã—</button>
      <img id="modal-image" src="" alt="×ª××•× ×” ××•×’×“×œ×ª" style="max-width:100%; max-height:80vh; border-radius:10px;" onclick="event.stopPropagation()">
    </div>
    <p style="position:absolute; bottom:20px; color:#fff; font-size:1.2rem; text-align:center;" id="modal-image-title"></p>
  </div>

  <header>
    <div class="user-buttons">
      <div id="login-btn"></div>
      <button id="profile-btn" style="display:none;">×”×¤×¨×•×¤×™×œ ×©×œ×™</button>
    </div>
    <img src="https://i.imgur.com/m6KeXAB.jpeg" alt="×œ×•×’×•" class="logo">
    <h1>×ª×¤×¨×™×˜ â€” Sushi Shifu</h1>
  </header>

  <nav class="tabs">
    <button class="tab-btn active" data-target="insideout">Inside-out</button>
    <button class="tab-btn" data-target="maki">Maki</button>
    <button class="tab-btn" data-target="onigiri">Onigiri</button>
    <button class="tab-btn" data-target="oshizushi">Oshizushi</button>
    <button class="tab-btn" data-target="poke">Poke</button>
    <button class="tab-btn" data-target="sauces">×¨×˜×‘×™×</button>
  </nav>

  <main id="main-content">
    <section id="menu-section">
      <div id="insideout" class="menu-category">
        <div class="category-title">Inside-out Rolls</div>
        <div id="insideout-rolls" class="category-container"></div>
      </div>

      <div id="maki" class="menu-category" style="display:none">
        <div class="category-title">Maki Rolls</div>
        <div id="maki-rolls" class="category-container"></div>
      </div>

      <div id="onigiri" class="menu-category" style="display:none">
        <div class="category-title">Onigiri</div>
        <div id="onigiri-rolls" class="category-container"></div>
      </div>

      <div id="oshizushi" class="menu-category" style="display:none">
        <div class="category-title">Oshizushi</div>
        <div id="oshizushi-rolls" class="category-container"></div>
      </div>

      <div id="poke" class="menu-category" style="display:none">
        <div class="category-title">Poke</div>
        <div id="poke-rolls" class="category-container"></div>
      </div>

      <div id="sauces" class="menu-category" style="display:none">
        <div class="category-title">×¨×˜×‘×™×</div>
        <div id="sauces-container" class="category-container"></div>
        <p class="note">×›×œ ×¨×•×œ ××§×‘×œ 2 ×¨×˜×‘×™× ×—×™× ×. ×¨×•×˜×‘ × ×•×¡×£ ×¢×•×œ×” 3â‚ª.</p>
      </div>
    </section>

    <section id="chopsticks">
      <div class="category-title">ğŸ¥¢ ×›××•×ª ×¦'×•×¤×¡×˜×™×§×¡</div>
      <div class="quantity-control" style="background:none; justify-content:flex-start;">
        <button id="chopsticks-minus">âˆ’</button>
        <input id="chopsticks-qty" type="number" readonly value="1" style="border:1px solid #444; border-radius:4px; color:var(--accent);">
        <button id="chopsticks-plus">+</button>
      </div>
    </section>

    <section id="notes-section">
      <div class="category-title">ğŸ“ ×”×¢×¨×•×ª ××™×©×™×•×ª</div>
      <textarea id="notes" placeholder="×”×¢×¨×•×ª ×œ××©×œ: ×‘×¨×•×œ × ×™×•×˜×•×Ÿ, ×œ×œ× ×¨×•×˜×‘ ×‘×•×˜× ×™×" oninput="updateSummary()"></textarea>
    </section>

    <section id="pickup-section">
      <div class="category-title">â° ×‘×—×¨ ×©×¢×ª ××™×¡×•×£</div>
      <select id="pickup-time" onchange="updateSummary()">
        <option value="">×‘×—×¨ ×©×¢×”</option>
      </select>
      <p class="note small" id="pickup-note">×”×©×¢×•×ª ×”×–××™× ×•×ª ××ª×¢×“×›× ×•×ª ×‘×”×ª×× ×œ×”×–×× ×•×ª ×§×™×™××•×ª</p>
    </section>

    <section id="summary-section">
      <div class="category-title">ğŸ›’ ×¡×™×›×•× ×”×–×× ×”</div>
      <pre id="order-summary">×”×–×× ×” ×¨×™×§×” â€” ×‘×—×¨ ×¨×•×œ×™×, ×¨×˜×‘×™× ×•×©×¢×” ×œ×”×¦×’×ª ×”×¡×™×›×•×.</pre>
      <button id="send-order" disabled>×©×œ×— ×”×–×× ×”</button>
    </section>
    
    <div id="messages"></div>

    <div id="profile-page" style="display:none;">
      <div class="category-title">ğŸ‘¤ ×”×¤×¨×•×¤×™×œ ×©×œ×™</div>
      
      <div style="background: #2a2a2a; color: #f0f0f0; padding:20px; border-radius:10px; margin-bottom:20px;">
        <h3 style="margin-top:0; color:var(--accent);">×¤×¨×˜×™× ××™×©×™×™×</h3>
        <div id="profile-view-mode">
          <p><strong>×©× ××œ×:</strong> <span id="display-name"></span></p>
          <p><strong>××™××™×™×œ:</strong> <span id="display-email"></span></p>
          <p><strong>×˜×œ×¤×•×Ÿ:</strong> <span id="display-phone"></span></p>
          <button id="edit-mode-btn" style="margin-top:15px; padding:10px 20px; background:var(--accent); color:#fff; border:none; border-radius:6px; cursor:pointer;">âœï¸ ×¢×¨×•×š ×¤×¨×˜×™×</button>
        </div>
        
        <div id="profile-edit-mode" style="display:none;">
           <label>×©× ××œ×:</label>
           <input type="text" id="edit-name" style="width:100%; margin-bottom:10px; padding:8px; background:#333; color:#fff; border:1px solid #555;">
           <label>×˜×œ×¤×•×Ÿ:</label>
           <input type="tel" id="edit-phone" style="width:100%; margin-bottom:10px; padding:8px; background:#333; color:#fff; border:1px solid #555;">
           <div style="display:flex; gap:10px;">
             <button id="save-profile-btn" style="padding:10px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer;">×©××•×¨</button>
             <button id="cancel-edit-btn" style="padding:10px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer;">×‘×™×˜×•×œ</button>
           </div>
        </div>
      </div>
      
      <div style="background: #2a2a2a; padding:20px; border-radius:10px;">
         <h3 style="color:var(--accent);">×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª</h3>
         <div id="order-history"></div>
      </div>
      
      <div style="text-align:center; margin-top:20px;">
        <button id="back-to-menu-btn" style="padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:6px; cursor:pointer;">â† ×—×–×•×¨ ×œ×ª×¤×¨×™×˜</button>
        <br><br>
        <button id="logout-btn-profile" style="padding:10px 20px; background:var(--danger); color:white; border:none; border-radius:6px; cursor:pointer;">ğŸšª ×”×ª× ×ª×§</button>
      </div>
    </div>
  </main>
</div>

<div id="order-popup" class="order-popup" style="display:none">
  <div class="order-popup__backdrop"></div>
  <div class="order-popup__box">
    <img src="https://i.imgur.com/m6KeXAB.jpeg" alt="×œ×•×’×•" style="width:100px; margin-bottom:10px; border-radius:6px;">
    <h2 id="order-popup-title">×©×™××• ×œ×‘!</h2>
    <p id="order-popup-message"></p>
    <button id="order-popup-ok" class="order-popup__ok">××™×©×•×¨</button>
  </div>
</div>

<script>
// ========================================
// ×”×’×“×¨×•×ª
// ========================================
const SUPABASE_URL = 'https://oxjokdjwdvmmdtcvqvon.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9rZGp3ZHZtbWR0Y3Zxdm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzgwMzMsImV4cCI6MjA3NDY1NDAzM30.DmKp79UiPi9iOU50UutevdqRcPyREMUJ7NT5ZmBHDsg';
const GOOGLE_CLIENT_ID = "962297663657-7bsrugivo5rjbu534lamiuc256gbqoc4.apps.googleusercontent.com";
const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/asitqrbtyjum10ph3vf6gxhkd766us3r";

let supabase = null;
let currentUser = null;
let orderItems = {};
let sauceSelections = {};
let chopsticksCount = 1;
let existingOrders = [];

// ========================================
// × ×ª×•× ×™×
// ========================================
const menuData = {
  insideout: [
    {name: '×¨×•×œ ×‘×™× ×’×•', desc: '×¡×œ××•×Ÿ × ×, ×©×× ×ª, ××‘×•×§×“×• ×‘×¦×™×¤×•×™ ×©×•××©×•× ×§×œ×•×™', price: 50, image_url: 'https://i.imgur.com/u5ebtHM.jpeg'},
    {name: '×¨×•×œ ×œ×•× ×”', desc: '×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ××¤×•×™ ×¢×œ ×¨×•×œ ×‘×˜×˜×”, ××‘×•×§×“×• ×•×©×™×˜××§×™', price: 50},
    {name: '×¨×•×œ ×¨×™×™', desc: '×˜×¨×˜×¨ ×¡×¤×™×™×¡×™ ×˜×•× ×” × × ×¢×œ ×¨×•×œ ××œ×¤×¤×•×Ÿ, ×¢×™×¨×™×ª ×•××•×©×™× ×§×•', price: 55},
    {name: '×¨×•×œ ×§×¨×™×™×–×™ ×‘×¨×•× ×•', desc: '×“×’ ×œ×‘×Ÿ, ×˜×•× ×”, ×¡×œ××•×Ÿ ×‘×¦×™×¤×•×™ ×©×•××©×•× ×§×œ×•×™', price: 60, image_url: 'https://i.imgur.com/rA4q1ND.jpeg'},
    {name: '×¨×•×œ ×”××¤×™ ×‘×¨×•× ×•', desc: '×¡×œ××•×Ÿ ×‘×¦×™×¤×•×™ ×©×§×“×™× ×§×œ×•×™×™× ×•×¨×•×˜×‘ ×˜×¨×™××§×™', price: 60, image_url: 'https://i.imgur.com/E3Uk19o.jpeg'},
    {name: '×¨×•×œ ××™×œ×”', desc: '×‘×˜×˜×”, ×¢×™×¨×™×ª ×•××‘×•×§×“×• ×‘×¢×™×˜×•×£ ×¡×œ××•×Ÿ ×¦×¨×•×‘', price: 50, image_url: 'https://i.imgur.com/UBhaUta.jpeg' },
    {name: '×¨×•×œ × ×™×•×˜×•×Ÿ', desc: '×˜×•× ×” ××“×•××”, ××‘×•×§×“×•, ×‘×˜×˜×” ×‘×¦×™×¤×•×™ ×¤× ×§×• ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 55, image_url: 'https://i.imgur.com/1fklsx4.jpeg'},
    {name: '×¨×•×œ ××•×œ×™', desc: '×“×’ ×œ×‘×Ÿ, ××œ×¤×¤×•×Ÿ, ××‘×•×§×“×• ×‘×¦×™×¤×•×™ ×©×•××©×•×', price: 50},
    {name: '×¨×•×œ ××™×œ×™', desc: '××§×œ ×¡×•×¨×™××™, ×“×’ ×œ×‘×Ÿ ××¤×•×™, ××•×©×™× ×§×• ×‘×¦×™×¤×•×™ ×¤× ×§×•', price: 50},
    {name: '×¨×•×œ ×¡×§××¨', desc: '×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ××¤×•×™ ×¢× ××‘×•×§×“×•, ××œ×¤×¤×•×Ÿ ×•×‘×˜×˜×” ×‘×¢×™×˜×•×¨ ××™×•× ×– ×•×¦\'×™×¤×¡', price: 50},
    {name: '×¨×•×œ ××’×™ ğŸŒ±', desc: '××œ×¤×¤×•×Ÿ, ×‘×˜×˜×”, ×¢×™×¨×™×ª ×•××‘×•×§×“×• ×‘×¢×™×˜×•×¨ ×‘×˜×˜×” ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 40},
    {name: '×¨×•×œ ×§×™×™×œ×”', desc: '×¡×œ××•×Ÿ × ×, ×§× ×¤×™×•, ×‘×˜×˜×” ×‘×¢×™×˜×•×£ ×©×‘×‘×™ ×¤× ×§×• ×¡×’×•×œ', price: 50},
    {name: '×¨×•×œ ×˜×™×™×¡×•×Ÿ', desc: '×¨×•×œ ××˜×•×’×Ÿ! ×¡×œ××•×Ÿ, ×‘×˜×˜×” ×•××œ×¤×¤×•×Ÿ ×‘×¦×™×¤×•×™ ×§×¨×™×¡×¤×™ ×•×¨×•×˜×‘ ×˜×¨×™××§×™', price: 60},
    {name: '×¨×•×œ ×œ×•×¡×™', desc: '×¡×œ××•×Ÿ × ×, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™ ×•××•×©×™× ×§×• ×‘×¦×™×¤×•×™ ×˜×•×‘×™×§×•', price: 55},
    {name: '×¨×•×œ ×‘×™×œ×™', desc: '×“×’ ×œ×‘×Ÿ ×¦×¨×•×‘, ×¢×™×¨×™×ª, ×‘×˜×˜×” ××¦×•×¤×” ×‘×¤× ×§×•', price: 50, image_url: 'https://i.imgur.com/AdT2Ync.jpeg'},
    {name: '×¨×•×œ ×œ××§×™', desc: '×˜×¨×˜×¨ ×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ×¢× ××‘×•×§×“×•, ××œ×¤×¤×•×Ÿ ×•×¢×™×¨×™×ª', price: 50}
  ],
  maki: [
    {name: '×¨×•×œ ××œ×¤×™', desc: '×××§×™ ×¡×œ××•×Ÿ', price: 35},
    {name: '×¨×•×œ ××™×™ ××™×™ ğŸŒ±', desc: '×××§×™ ×‘×˜×˜×” ×•××‘×•×§×“×•', price: 25},
    {name: '×¨×•×œ ×¡× ×•×¤×™ ğŸŒ±', desc: '×××§×™ ××•×©×™× ×§×• ×•×§× ×¤×™×•', price: 25}
  ],
  onigiri: [
    {name: '××•× ×™×’×™×¨×™ ×¨×•×§×™', desc: '×˜×¨×˜×¨ ×˜×•× ×” ××“×•××” ×¢× ×¡×¤×™×™×¡×™ ××™×•× ×– ×•×‘×¦×œ ×™×¨×•×§', price: 35, image_url:'https://i.imgur.com/VW9Iexm.jpeg'},
    {name: '××•× ×™×’×™×¨×™ ×’\'×•× ×™', desc: '×˜×¨×˜×¨ ×¡×œ××•×Ÿ ×¢× ×¡×¤×™×™×¡×™ ××™×•× ×– ×•×‘×¦×œ ×™×¨×•×§', price: 30, image_url:'https://i.imgur.com/VW9Iexm.jpeg'},
    {name: '××•× ×™×’×™×¨×™ ×’\'×™×–×œ ğŸŒ±', desc: '××‘×•×§×“×• ×•×‘×˜×˜×”', price: 25 , image_url:'https://i.imgur.com/VW9Iexm.jpeg'}
  ],
  oshizushi: [
    {name: '××•×©×™×–×•×©×™ ×¡×œ××•×Ÿ ×§×œ××¡×™', desc: '6 ×™×—\' - ×©×›×‘×ª ×¡×œ××•×Ÿ ×˜×¨×™ ×•×©×›×‘×ª ××‘×•×§×“×• ×œ×—×•×¦×™× ×‘×™×Ÿ ×©×›×‘×•×ª ××•×¨×– ×¡×•×©×™', price: 50},
    {name: '××•×©×™×–×•×©×™ ×˜×•× ×” ×¤×™×§× ×˜×™', desc: '6 ×™×—\' - ×©×›×‘×ª ×˜×•× ×” ××“×•××” ×•×©×›×‘×ª ×‘×˜×˜×” ×œ×—×•×¦×™× ×‘×™×Ÿ ×©×›×‘×•×ª ××•×¨×– ×¡×•×©×™', price: 55},
    {name: '××•×©×™×–×•×©×™ ×¦××—×•× ×™ ğŸŒ±', desc: '6  ×™×—\' - ×©×›×‘×ª ××‘×•×§×“×• ×•×©×›×‘×ª ×‘×˜×˜×” ×œ×—×•×¦×™× ×‘×™×Ÿ ×©×›×‘×•×ª ××•×¨×– ×¡×•×©×™ ', price: 40}
  ],
  poke: [
    {name: '×‘×•×œ-×“×•×’', desc: '××•×¨×– ×¡×•×©×™, ×¡×œ××•×Ÿ ×‘××¨×™× ×“×”, ××“×××”, ××œ×¤×¤×•×Ÿ, ××‘×•×§×“×•, ×‘×¦×œ ×™×¨×•×§. ××¢×œ ×©×•××©×•× ×•×¨×•×˜×‘ ×¡×¤×™×™×¡×™ ××™×•× ×–', price: 60, image_url:'https://i.imgur.com/cUf6gYx.jpeg'},
    {name: '×¤×™×˜-×‘×•×œ', desc: '××•×¨×– ×¡×•×©×™, ×˜×•× ×” ×‘××¨×™× ×“×”, ××“×××”, ×× ×’×•, ×›×¨×•×‘ ×¡×’×•×œ. ××¢×œ ×‘×¦×œ ×©××œ×•×˜ ××˜×•×’×Ÿ ×•×¨×•×˜×‘ ×¦×³×™×œ×™ ×× × ×¡ ××ª×•×§', price: 70, image_url:'https://i.imgur.com/DhFRUGl.jpeg'},
    {name: '×‘×•×œ-×˜×¨×™×™×¨ ğŸŒ±', desc: '××•×¨×– ×¡×•×©×™, ××“×××”, ××œ×¤×¤×•×Ÿ, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™, ×’×–×¨ ×•××‘×•×§×“×•. ××¢×œ ×©×•××©×•× ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 45, image_url:'https://i.imgur.com/GvXgFPY.jpeg'}
  ],
  sauces: [
    {name: '×¡×¤×™×™×¡×™ ××™×•× ×–', price: 0},
    {name: '×¨×•×˜×‘ ×¡×•×™×”', price: 0},
    {name: '×¨×•×˜×‘ ×˜×¨×™××§×™', price: 0},
    {name: '×’\'×™× ×’\'×¨', price: 0},
    {name: '×•×•××¡×‘×™', price: 0}
  ]
};

// ========================================
// ××ª×—×•×œ
// ========================================
document.addEventListener('DOMContentLoaded', async function() {
  if (typeof window.supabase !== 'undefined') {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  initGoogleAuth();
  checkLocalAuth();
  renderMenu();
  setupTabs();
  setupChopsticks();
  setupSendOrder();
  setupProfileButton();
  updateSummary();
  await loadExistingOrders();
  checkDayOfWeek(); // ×¤×•×¤××¤ ×™×•× ×¨×‘×™×¢×™
});

// ========================================
// AUTH
// ========================================
function initGoogleAuth() {
  if (!window.google?.accounts?.id) {
    setTimeout(initGoogleAuth, 500);
    return;
  }
  window.google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleGoogleLogin
  });
  window.google.accounts.id.renderButton(
    document.getElementById('login-btn'),
    { theme: 'filled_black', size: 'medium', text: 'signin', locale: 'he' }
  );
}

async function handleGoogleLogin(response) {
    try {
        const decoded = jwt_decode(response.credential);
        let phone = '';
        if (supabase) {
            const { data } = await supabase.from('users').select('phone').eq('email', decoded.email).single();
            if (data && data.phone) phone = data.phone;
        }
        
        if (!phone) {
           phone = await promptForPhone();
           if (!phone) {
               alert('×—×•×‘×” ×œ×”×–×™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×›×“×™ ×œ×”×–××™×Ÿ.');
               return; 
           }
           if (supabase) {
               await supabase.from('users').upsert({
                   email: decoded.email,
                   name: decoded.name,
                   phone: phone,
                   last_login: new Date()
               });
           }
        }

        currentUser = {
            name: decoded.name,
            email: decoded.email,
            picture: decoded.picture,
            phone: phone
        };
        localStorage.setItem('sushiUser', JSON.stringify(currentUser));
        updateUIAfterLogin();
    } catch(e) { console.error(e); }
}

function checkLocalAuth() {
    const stored = localStorage.getItem('sushiUser');
    if (stored) {
        currentUser = JSON.parse(stored);
        updateUIAfterLogin();
    }
}

function updateUIAfterLogin() {
    document.getElementById('login-btn').style.display = 'none';
    const pBtn = document.getElementById('profile-btn');
    pBtn.style.display = 'inline-block';
    if(currentUser.picture) {
        pBtn.innerHTML = `<img src="${currentUser.picture}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-left:5px"> ×”×¤×¨×•×¤×™×œ ×©×œ×™`;
    }
}

function promptForPhone() {
    return new Promise((resolve) => {
        const modal = document.getElementById('phone-modal');
        const input = document.getElementById('phone-input');
        const err = document.getElementById('phone-error');
        modal.style.display = 'flex';
        input.value = '';
        err.style.display = 'none';
        
        window.submitPhone = () => {
            let val = input.value.trim().replace(/\D/g,'');
            if (val.length === 10 && val.startsWith('05')) {
                const formatted = val.slice(0,3) + '-' + val.slice(3);
                modal.style.display = 'none';
                resolve(formatted);
            } else {
                err.style.display = 'block';
            }
        };
        window.cancelPhone = () => {
            modal.style.display = 'none';
            resolve(null);
        };
    });
}

// ========================================
// RENDER MENU
// ========================================
function renderMenu() {
    ['insideout','maki','onigiri','oshizushi','poke'].forEach(cat => renderCategory(cat, cat+'-rolls'));
    renderSauces();
}

function renderCategory(category, containerId) {
    const container = document.getElementById(containerId);
    if(!container) return;
    
    container.innerHTML = menuData[category].map((item, idx) => {
        const key = `${category}_${idx}`;
        const imageHTML = item.image_url 
            ? `<img src="${item.image_url}" class="roll-image" onclick="openImageModal('${item.image_url}', '${item.name}')">`
            : `<div class="roll-image-placeholder">ğŸ£</div>`;
            
        return `
        <div class="roll-card">
            <div class="roll-card-content">
                ${imageHTML}
                <div class="info">
                    <h3>${item.name}</h3>
                    <p>${item.desc}</p>
                    <p><strong>${item.price}â‚ª</strong></p>
                </div>
            </div>
            <div class="quantity-control">
                <button onclick="changeQty('${key}', -1)">âˆ’</button>
                <input type="number" id="${key}" value="0" readonly>
                <button onclick="changeQty('${key}', 1)">+</button>
            </div>
        </div>`;
    }).join('');
}

function renderSauces() {
    const container = document.getElementById('sauces-container');
    if(!container) return;
    container.innerHTML = menuData.sauces.map((item, idx) => {
        const key = `sauce_${idx}`;
        return `
        <div class="roll-card">
            <div class="roll-card-content">
                <div class="info">
                    <h3>${item.name}</h3>
                    ${item.price > 0 ? `<p>${item.price}â‚ª</p>` : ''}
                </div>
            </div>
            <div class="quantity-control">
                <button onclick="changeSauce('${key}', -1)">âˆ’</button>
                <input type="number" id="${key}" value="0" readonly>
                <button onclick="changeSauce('${key}', 1)">+</button>
            </div>
        </div>`;
    }).join('');
}

// ========================================
// LOGIC
// ========================================
window.changeQty = function(key, delta) {
    const input = document.getElementById(key);
    let val = parseInt(input.value) || 0;
    val = Math.max(0, val + delta);
    input.value = val;
    if(val > 0) orderItems[key] = val; else delete orderItems[key];
    generatePickupSlots();
    updateSummary();
}
window.changeSauce = function(key, delta) {
    const input = document.getElementById(key);
    let val = parseInt(input.value) || 0;
    val = Math.max(0, val + delta);
    input.value = val;
    if(val > 0) sauceSelections[key] = val; else delete sauceSelections[key];
    updateSummary();
}

function setupTabs() {
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('profile-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            tabs.forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            document.querySelectorAll('.menu-category').forEach(el => el.style.display = 'none');
            const target = btn.getAttribute('data-target');
            document.getElementById(target).style.display = 'block';
            
            // ×’×œ×™×œ×” ×—×œ×§×” ×œ××¢×œ×”
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });
}

function setupChopsticks() {
    document.getElementById('chopsticks-minus').onclick = () => {
        if(chopsticksCount > 0) { chopsticksCount--; document.getElementById('chopsticks-qty').value = chopsticksCount; updateSummary(); }
    };
    document.getElementById('chopsticks-plus').onclick = () => {
        chopsticksCount++; document.getElementById('chopsticks-qty').value = chopsticksCount; updateSummary(); 
    };
}

function generatePickupSlots() {
    const select = document.getElementById('pickup-time');
    const currentVal = select.value;
    select.innerHTML = '<option value="">×‘×—×¨ ×©×¢×”</option>';
    
    // ×—×™×©×•×‘ ×–×× ×™ ×”×›× ×” - ×œ×•×’×™×§×” ×¤×©×•×˜×”
    // ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ××ª ×”×œ×•×’×™×§×” ×”×—×›××” ×©×œ ×”×ª× ×’×©×•×™×•×ª ×× ×¨×•×¦×™×
    
    for(let h=19; h<=22; h++) {
        for(let m=0; m<60; m+=15) {
            if(h===22 && m>30) continue;
            const timeStr = `${h}:${m.toString().padStart(2,'0')}`;
            const opt = document.createElement('option');
            opt.value = timeStr;
            opt.textContent = timeStr;
            select.appendChild(opt);
        }
    }
    select.value = currentVal;
}

function updateSummary() {
    let total = 0;
    let count = 0;
    let text = "";
    
    // ×¨×•×œ×™×
    for(let k in orderItems) {
        const [cat, idx] = k.split('_');
        const item = menuData[cat][idx];
        const qty = orderItems[k];
        const cost = item.price * qty;
        text += `${item.name} x${qty} = ${cost}â‚ª\n`;
        total += cost;
        count += qty;
    }
    
    // ×¨×˜×‘×™×
    let sauceCount = 0;
    for(let k in sauceSelections) sauceCount += sauceSelections[k];
    const free = count * 2;
    const extra = Math.max(0, sauceCount - free);
    const sauceCost = extra * 3;
    if(sauceCount > 0) {
        text += `\n×¨×˜×‘×™×: ${sauceCount} (${free} ×—×™× ×)\n×ª×•×¡×¤×ª ×¨×˜×‘×™×: ${sauceCost}â‚ª\n`;
        total += sauceCost;
    }
    
    text += `\n×¦'×•×¤×¡×˜×™×§×¡: ${chopsticksCount}`;
    text += `\n×¡×”"×› ×œ×ª×©×œ×•×: ${total}â‚ª`;
    
    document.getElementById('order-summary').textContent = count ? text : '×”×–×× ×” ×¨×™×§×”...';
    
    const btn = document.getElementById('send-order');
    const time = document.getElementById('pickup-time').value;
    
    if(count > 0 && time && count <= 15) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
    } else {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
    }
}

// ========================================
// SEND ORDER
// ========================================
function setupSendOrder() {
    document.getElementById('send-order').addEventListener('click', async () => {
        if(!currentUser) {
            alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×–××™×Ÿ');
            initGoogleAuth();
            return;
        }
        
        const btn = document.getElementById('send-order');
        btn.disabled = true;
        btn.textContent = '×©×•×œ×—...';
        
        try {
            const orderData = {
                user_name: currentUser.name,
                email: currentUser.email,
                phone: currentUser.phone,
                order_date: new Date().toISOString().split('T')[0],
                pickup_time: document.getElementById('pickup-time').value,
                items: JSON.stringify(orderItems),
                sauces: JSON.stringify(sauceSelections),
                chopsticks: chopsticksCount,
                notes: document.getElementById('notes').value,
                total_price: parseInt(document.getElementById('order-summary').textContent.split('×¡×”"×› ×œ×ª×©×œ×•×: ')[1]),
                items_summary: document.getElementById('order-summary').textContent
            };

            if(supabase) {
                const { error } = await supabase.from('Sushi').insert([orderData]);
                if(error) throw error;
            }
            
            await fetch(MAKE_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            
            document.getElementById('messages').innerHTML = '<span style="color:green">×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”! ğŸ‰</span>';
            setTimeout(() => location.reload(), 2000);
            
        } catch(err) {
            console.error(err);
            document.getElementById('messages').innerHTML = '<span style="color:red">×©×’×™××” ×‘×©×œ×™×—×”.</span>';
            btn.disabled = false;
            btn.textContent = '×©×œ×— ×”×–×× ×”';
        }
    });
}

// ========================================
// PROFILE
// ========================================
function setupProfileButton() {
    document.getElementById('profile-btn').onclick = () => {
        document.getElementById('main-content').querySelectorAll('section').forEach(s => s.style.display='none');
        document.getElementById('profile-page').style.display = 'block';
        if(currentUser) {
            document.getElementById('display-name').textContent = currentUser.name;
            document.getElementById('display-email').textContent = currentUser.email;
            document.getElementById('display-phone').textContent = currentUser.phone;
            loadHistory();
        }
    };
    
    document.getElementById('back-to-menu-btn').onclick = () => {
        document.getElementById('profile-page').style.display = 'none';
        document.querySelector('.tab-btn.active').click(); 
    };
    
    document.getElementById('edit-mode-btn').onclick = () => {
        document.getElementById('profile-view-mode').style.display = 'none';
        document.getElementById('profile-edit-mode').style.display = 'block';
        document.getElementById('edit-name').value = currentUser.name;
        document.getElementById('edit-phone').value = currentUser.phone;
    };
    
    document.getElementById('cancel-edit-btn').onclick = () => {
        document.getElementById('profile-edit-mode').style.display = 'none';
        document.getElementById('profile-view-mode').style.display = 'block';
    };
    
    document.getElementById('save-profile-btn').onclick = () => {
        currentUser.name = document.getElementById('edit-name').value;
        currentUser.phone = document.getElementById('edit-phone').value;
        localStorage.setItem('sushiUser', JSON.stringify(currentUser));
        
        if (supabase) {
            supabase.from('users').update({
                name: currentUser.name,
                phone: currentUser.phone
            }).eq('email', currentUser.email).then(console.log);
        }
        
        document.getElementById('display-name').textContent = currentUser.name;
        document.getElementById('display-phone').textContent = currentUser.phone;
        document.getElementById('profile-edit-mode').style.display = 'none';
        document.getElementById('profile-view-mode').style.display = 'block';
    };
    
    document.getElementById('logout-btn-profile').onclick = () => {
        localStorage.removeItem('sushiUser');
        currentUser = null;
        location.reload();
    };
}

async function loadExistingOrders() {
    if(!supabase) return;
    const today = new Date().toISOString().split('T')[0];
    const { data } = await supabase.from('Sushi').select('*').eq('order_date', today);
    if(data) existingOrders = data;
    generatePickupSlots();
}

async function loadHistory() {
    if (!supabase || !currentUser) return;
    const { data } = await supabase.from('Sushi').select('*').eq('email', currentUser.email).order('created_at', {ascending: false});
    
    const container = document.getElementById('order-history');
    if (!data || data.length === 0) {
        container.textContent = '××™×Ÿ ×”×–×× ×•×ª ×§×•×“××•×ª';
        return;
    }
    
    container.innerHTML = data.map(o => `
        <div style="border-bottom:1px solid #444; padding:10px 0;">
            <div><strong>${o.order_date}</strong> | ×©×¢×” ${o.pickup_time}</div>
            <div style="color:var(--accent)">×¡×”"×›: ${o.total_price}â‚ª</div>
        </div>
    `).join('');
}

// ========================================
// MODALS
// ========================================
window.openImageModal = (url, title) => {
    document.getElementById('modal-image').src = url;
    document.getElementById('modal-image-title').textContent = title;
    document.getElementById('image-modal').style.display = 'flex';
};
window.closeImageModal = () => document.getElementById('image-modal').style.display = 'none';

// ========================================
// POPUP LOGIC
// ========================================
function checkDayOfWeek() {
  const now = new Date();
  const day = now.getDay(); // 0=Sunday, 3=Wednesday
  const isWednesday = (day === 3); 
  
  const popup = document.getElementById('order-popup');
  const msg = document.getElementById('order-popup-message');
  const title = document.getElementById('order-popup-title');
  const okBtn = document.getElementById('order-popup-ok');

  if (!isWednesday) {
    title.textContent = "×©×™××• ×œ×‘! ğŸ“…";
    msg.innerHTML = "×”×”×–×× ×•×ª ×‘××ª×¨ × ×¤×ª×—×•×ª ×‘×™××™ ×¨×‘×™×¢×™ ×‘×œ×‘×“.<br>× ×™×ª×Ÿ ×œ×¢×™×™×Ÿ ×‘×ª×¤×¨×™×˜, ××š ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×”×–×× ×” ×›×¨×’×¢.";
    popup.style.display = 'flex';
    
    // ×›×¤×ª×•×¨ ××™×©×•×¨ ×¡×•×’×¨ ××ª ×”×¤×•×¤××¤
    okBtn.onclick = function() {
        popup.style.display = 'none';
    };
  }
}
</script>
</body>
</html>
