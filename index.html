<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>סושי אונליין</title>
<style>
  :root {
    --accent: #7a2a2a;
    --accent-dark: #5e1b1b;
    --bg: #fff;
    --danger: #d9534f;
  }
  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: linear-gradient(180deg,#f6f5f4, #efecec);
    color: #222;
  }
  header { display: flex; justify-content: space-between; align-items: center; padding: 12px; flex-wrap: wrap; }
  .logo-container { width: 100%; text-align: center; margin-bottom: 12px; }
  .logo { max-width: 150px; height: auto; border-radius: 8px; }
  .user-actions { order: -1; margin-right: 0; display: flex; gap: 8px; align-items: center; }
  .btn { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; }
  .btn.primary { background: var(--accent); color: #fff; }
  .btn.secondary { background: #fff; color: var(--accent); border:1px solid #ddd; }
  .tabs { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 12px; }
  .tab { padding: 8px 12px; border-radius: 8px; background: #fff; border:1px solid #eee; font-weight:700; cursor:pointer; }
  .tab.active { background: var(--accent); color: #fff; border-color: var(--accent-dark); }
  main { display: flex; flex-direction: column; gap: 12px; max-width: 1200px; margin: auto; padding: 12px; }
  .category-container { display: flex; flex-direction: column; gap: 10px; }
  .roll-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius:10px; background: var(--bg); box-shadow:0 4px 14px rgba(0,0,0,0.05); }
  .quantity-control { display: flex; gap: 8px; }
  .quantity-control button { width: 36px; height: 36px; border-radius: 8px; border: none; background: #f0c0c0; color: var(--accent); font-weight:700; font-size:1.2rem; cursor:pointer; }
  .quantity-control input { width: 50px; text-align: center; border:1px solid #ddd; border-radius:6px; }
  #side-area { display: flex; flex-direction: column; gap: 12px; }
  .panel { background: #fff; padding: 12px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,0.04); }
  .panel-title { font-weight:800; color: var(--accent); margin-bottom:8px; }
  #notes { width: 100%; min-height: 80px; border-radius: 6px; border:1px solid #ddd; padding:8px; }
  #order-summary { background: #fafafa; padding:10px; border-radius:8px; min-height:120px; white-space: pre-wrap; font-family:"Courier New", monospace; }
  #messages { color: var(--danger); font-weight:700; margin-top:8px; }
  @media(max-width:980px) { main { flex-direction: column; } }
</style>
</head>
<body>
<header>
  <div class="logo-container">
    <img src="https://i.imgur.com/m6KeXAB.jpeg" alt="לוגו" class="logo" />
  </div>
  <div class="user-actions">
    <button id="auth-btn" class="btn primary">התחבר</button>
  </div>
</header>
<div class="tabs">
  <button class="tab active" data-target="insideout-rolls">Inside-out</button>
  <button class="tab" data-target="maki-rolls">Maki</button>
  <button class="tab" data-target="onigiri-rolls">Onigiri</button>
  <button class="tab" data-target="poke-rolls">Poke</button>
  <button class="tab" data-target="oshizushi-rolls">Oshizushi</button>
</div>

<main>
  <section id="menu-area">
    <div id="insideout-rolls" class="category-container"></div>
    <div id="maki-rolls" class="category-container" style="display:none;"></div>
    <div id="onigiri-rolls" class="category-container" style="display:none;"></div>
    <div id="poke-rolls" class="category-container" style="display:none;"></div>
    <div id="oshizushi-rolls" class="category-container" style="display:none;"></div>
  </section>
  
  <aside id="side-area">
    <section class="panel">
      <div class="panel-title">רטבים</div>
      <div id="sauces-container" class="category-container"></div>
      <p class="note">כל רול מקבל 2 רטבים חינם. רוטב נוסף 3₪.</p>
    </section>
    <section class="panel">
      <div class="panel-title">כמות צ'ופסטיקס</div>
      <div class="quantity-control">
        <button id="chopsticks-minus">−</button>
        <input id="chopsticks-qty" type="number" readonly value="1">
        <button id="chopsticks-plus">+</button>
      </div>
    </section>
    <section class="panel">
      <div class="panel-title">בחר שעת איסוף</div>
      <select id="pickup-time"><option value="">בחר שעה</option></select>
    </section>
    <section class="panel">
      <div class="panel-title">הערות אישיות</div>
      <textarea id="notes" placeholder="לדוגמה: ללא גלוטן, הגעה בשער 3..."></textarea>
    </section>
    <section class="panel">
      <div class="panel-title">סיכום הזמנה</div>
      <pre id="order-summary">הזמנה ריקה — בחר רולים, רטבים ושעה להצגת הסיכום.</pre>
      <div class="actions-row">
        <button id="send-order" class="btn primary">שלח הזמנה</button>
      </div>
    </section>
    <div id="messages" aria-live="polite"></div>
  </aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

<script>
// ====== CONFIG ======
const SUPABASE_URL = 'https://oxjokdjwdvmmdtcvqvon.supabase.co';
const SUPABASE_KEY = 'YOUR_SUPABASE_KEY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const GOOGLE_CLIENT_ID = '962297663657-7bsrugivo5rjbu534lamiuc256gbqoc4.apps.googleusercontent.com';
const MAKE_WEBHOOK_URL = 'https://hook.eu2.make.com/asitqrbtyjum10ph3vf6gxhkd766us3r';

// ====== STATE ======
let chopsticksCount = 1;
let selectedRolls = {};
let selectedSauces = {};
let currentUser = null;
let bookedTimes = JSON.parse(localStorage.getItem('bookedTimes')||'[]');
let dailyRollCount = JSON.parse(localStorage.getItem('dailyRollCount')||'{}');

// ====== DATA ======
const insideOutRollsData = [
  {id:"bingo", name:"רול בינגו - 50₪", description:"סלמון נא, שמנת, אבוקדו בציפוי שומשום קלוי", price:50},
  {id:"luna", name:"רול לונה - 50₪", description:"ספייסי סלמון אפוי על רול בטטה, אבוקדו ושיטאקי", price:50},
  {id:"belgian", name:"רול ריי - 55₪", description:"טרטר ספייסי טונה נא על רול מלפפון, עירית ואושינקו", price:55},
  {id:"crazy-bruno", name:"רול קרייזי ברונו - 60₪", description:"דג לבן, טונה, סלמון בציפוי שומשום קלוי", price:60},
  {id:"happy-bruno", name:"רול האפי ברונו - 60₪", description:"סלמון בציפוי שקדים קלויים ורוטב טריאקי", price:60},
  {id:"mila", name:"רול מילה - 50₪", description:"בטטה, עירית ואבוקדו בעיטוף סלמון צרוב", price:50},
  {id:"newton", name:"רול ניוטון - 55₪", description:"טונה אדומה, אבוקדו, בטטה בציפוי פנקו ורוטב בוטנים", price:55},
  {id:"oli", name:"רול אולי - 50₪", description:"דג לבן, מלפפון, אבוקדו בציפוי שומשום", price:50},
  {id:"milli", name:"רול מילי - 50₪", description:"סלמון, אבוקדו, עגבנייה, מלפפון", price:50},
  {id:"sylvie", name:"רול סילבי - 55₪", description:"טונה אדומה, אבוקדו, מלפפון בציפוי שומשום קלוי", price:55}
];
const makiRollsData = [...insideOutRollsData]; // דוגמא
const onigiriRollsData = [...insideOutRollsData]; // דוגמא
const pokeRollsData = [...insideOutRollsData]; // דוגמא
const oshizushiRollsData = [...insideOutRollsData]; // דוגמא

const saucesData = ["Spicy Mayo", "Soy", "Teriyaki", "Ginger", "Wasabi"];

// ====== FUNCTIONS ======
function renderRolls() {
  const categories = [
    {id:"insideout-rolls", data:insideOutRollsData},
    {id:"maki-rolls", data:makiRollsData},
    {id:"onigiri-rolls", data:onigiriRollsData},
    {id:"poke-rolls", data:pokeRollsData},
    {id:"oshizushi-rolls", data:oshizushiRollsData}
  ];
  categories.forEach(cat=>{
    const container = document.getElementById(cat.id);
    container.innerHTML = "";
    cat.data.forEach(roll=>{
      const card = document.createElement('div');
      card.className = "roll-card";
      card.innerHTML = `
        <div>
          <strong>${roll.name}</strong><br><small>${roll.description}</small>
        </div>
        <div class="quantity-control">
          <button class="minus">−</button>
          <input type="number" value="0" readonly>
          <button class="plus">+</button>
        </div>
      `;
      const minusBtn = card.querySelector(".minus");
      const plusBtn = card.querySelector(".plus");
      const input = card.querySelector("input");
      minusBtn.addEventListener("click",()=>{
        if(input.value>0){ input.value--; selectedRolls[roll.id]=input.value; updateOrderSummary(); }
      });
      plusBtn.addEventListener("click",()=>{
        input.value++;
        selectedRolls[roll.id]=input.value;
        updateOrderSummary();
      });
      container.appendChild(card);
    });
  });
}

function renderSauces() {
  const container = document.getElementById("sauces-container");
  container.innerHTML = "";
  saucesData.forEach(s=>{
    const div = document.createElement("div");
    div.innerHTML = `<label><input type="checkbox" value="${s}"> ${s}</label>`;
    div.querySelector("input").addEventListener("change",e=>{
      if(e.target.checked){ selectedSauces[s]=true; } else { delete selectedSauces[s]; }
      updateOrderSummary();
    });
    container.appendChild(div);
  });
}

function renderPickupTimes() {
  const select = document.getElementById("pickup-time");
  select.innerHTML = '<option value="">בחר שעה</option>';
  for(let h=19; h<=22; h++){
    for(let m=0; m<60; m+=30){
      if(h===22 && m>30) continue;
      const time = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
      if(!bookedTimes.includes(time)){
        const option = document.createElement("option");
        option.value = time;
        option.textContent = time;
        select.appendChild(option);
      }
    }
  }
}

function updateOrderSummary() {
  let sum = 0;
  let text = "";
  Object.keys(selectedRolls).forEach(id=>{
    const qty = selectedRolls[id];
    if(qty>0){
      const roll = [...insideOutRollsData,...makiRollsData,...onigiriRollsData,...pokeRollsData,...oshizushiRollsData].find(r=>r.id===id);
      sum += roll.price*qty;
      text += `${roll.name} x ${qty} = ${roll.price*qty}₪\n`;
    }
  });
  const saucesArr = Object.keys(selectedSauces);
  text += saucesArr.length? `רטבים: ${saucesArr.join(", ")}\n` : "";
  const chopsticksQty = document.getElementById("chopsticks-qty").value;
  text += `כמות צ'ופסטיקס: ${chopsticksQty}\n`;
  const notes = document.getElementById("notes").value;
  if(notes) text += `הערות: ${notes}\n`;
  const time = document.getElementById("pickup-time").value;
  if(time) text += `שעת איסוף: ${time}\n`;
  text += `סה"כ: ${sum}₪`;
  document.getElementById("order-summary").textContent = text;
}

document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    document.querySelectorAll(".category-container").forEach(c=>c.style.display="none");
    document.getElementById(tab.dataset.target).style.display="flex";
  });
});

document.getElementById("chopsticks-minus").addEventListener("click",()=>{
  if(chopsticksCount>1) chopsticksCount--;
  document.getElementById("chopsticks-qty").value = chopsticksCount;
  updateOrderSummary();
});
document.getElementById("chopsticks-plus").addEventListener("click",()=>{
  chopsticksCount++;
  document.getElementById("chopsticks-qty").value = chopsticksCount;
  updateOrderSummary();
});

// ===== AUTH BUTTON =====
document.getElementById("auth-btn").addEventListener("click",()=> {
  // כאן יופעל התחברות Google או Guest (קוד מלא מחובר ל-Supabase)
  alert("פונקציית התחברות מלאה מחוברת ל-Google/Supabase");
});

// ===== SEND ORDER =====
document.getElementById("send-order").addEventListener("click",()=>{
  const time = document.getElementById("pickup-time").value;
  if(Object.values(selectedRolls).filter(v=>v>0).length===0){
    document.getElementById("messages").textContent = "בחר לפחות רול אחד!";
    return;
  }
  if(!time){
    document.getElementById("messages").textContent = "בחר שעת איסוף!";
    return;
  }
  const payload = {
    user: currentUser||"Guest",
    rolls: selectedRolls,
    sauces: Object.keys(selectedSauces),
    chopsticks: chopsticksCount,
    notes: document.getElementById("notes").value,
    pickupTime: time,
    createdAt: new Date().toISOString()
  };
  // שליחה ל-Make
  fetch(MAKE_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  // שמירה ל-Supabase
  supabase.from('orders').insert([payload]).then(r=>console.log("Supabase OK",r));
  alert("ההזמנה נשלחה בהצלחה!");
  // איפוס טפסים
  selectedRolls = {};
  selectedSauces = {};
  document.querySelectorAll(".category-container input").forEach(i=>i.value=0);
  document.querySelectorAll("#sauces-container input").forEach(i=>i.checked=false);
  document.getElementById("notes").value="";
  document.getElementById("pickup-time").value="";
  updateOrderSummary();
});

renderRolls();
renderSauces();
renderPickupTimes();
updateOrderSummary();
</script>
</body>
</html>
