<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×¡×•×©×™ ××•× ×œ×™×™×Ÿ â€” ×§×˜×’×•×¨×™×•×ª ×‘×©×•×¨×” ××—×ª</title>

  <!-- ×× ×ª×¨×¦×” Supabase (××•×¤×¦×™×•× ×œ×™) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <!-- Google Sign-In (×× ×ª×›× ×™×¡ client id) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- jwt-decode ×§×˜×Ÿ ×œ×™×¦×™×¨×ª ×¤×¨×•×¤×™×œ ××”-credential ×©×œ Google -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

  <style>
    :root{
      --accent: #7a2a2a;
      --accent-dark: #5e1b1b;
      --muted: #f6f5f4;
      --bg: #fff;
      --danger: #d9534f;
    }

    /* reset */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f6f5f4,#efecec);
      color:#222;
      direction: rtl;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .page {
      max-width:1200px;
      margin:12px auto;
      padding:14px;
      background: rgba(255,255,255,0.96);
      border-radius:12px;
      box-shadow: 0 8px 26px rgba(0,0,0,0.06);
    }

    /* TOP ROW: auth button on its own row, left-top */
    .top-row {
      display:flex;
      align-items:center;
      justify-content:flex-start; /* visually left if direction:ltr inside */
      gap:12px;
      padding:6px 6px 8px 6px;
    }
    /* force left alignment inside RTL page: use a container with ltr */
    .auth-wrap{
      width:100%;
      direction:ltr;
      display:flex;
      justify-content:flex-start; /* left of viewport */
      align-items:center;
    }
    .auth-btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #eee;
      background:#fff;
      color:var(--accent);
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    /* LOGO row: center large logo */
    .logo-row{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:10px 0;
    }
    .logo {
      width:160px;
      height:auto;
      border-radius:12px;
      object-fit:contain;
      box-shadow:0 8px 20px rgba(0,0,0,0.06);
      background:linear-gradient(180deg,#fff,#fafafa);
      padding:8px;
    }
    @media(max-width:480px){
      .logo { width:120px; }
    }

    /* CATEGORIES row: single-line, no wrap, horizontal scroll on small screens */
    .categories-row {
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 6px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      white-space:nowrap;
      scrollbar-width: thin;
      scrollbar-color: rgba(122,42,42,0.2) transparent;
    }
    .categories-row::-webkit-scrollbar{ height:8px; }
    .categories-row::-webkit-scrollbar-thumb{ background: rgba(122,42,42,0.15); border-radius:8px; }

    .cat-btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
      padding:10px 14px;
      border-radius:999px;
      background:#fff;
      border:1px solid #eee;
      cursor:pointer;
      font-weight:800;
      color:var(--accent);
      box-shadow: 0 6px 18px rgba(0,0,0,0.03);
      white-space:nowrap;
    }
    .cat-btn.active {
      background: var(--accent);
      color:#fff;
      border-color:var(--accent-dark);
      box-shadow: 0 10px 26px rgba(122,42,42,0.12);
    }

    /* layout: main content with menu and aside */
    .main {
      display:flex;
      gap:18px;
      align-items:flex-start;
      margin-top:12px;
    }
    .menu-area { flex:1; display:flex; flex-direction:column; gap:12px; min-width:0; }
    .category-container { display:flex; flex-direction:column; gap:10px; padding:6px 0; }

    /* aside */
    aside.side { width:360px; flex:0 0 360px; }
    @media(max-width:980px){
      .main{ flex-direction:column; }
      aside.side{ width:100%; flex:unset; }
    }

    /* cards */
    .roll-card {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:10px;
      background:var(--bg);
      box-shadow:0 4px 14px rgba(0,0,0,0.04);
    }
    .roll-card .info{ flex:1 1 auto; min-width:0; }
    .roll-card h3{ margin:0; color:var(--accent); font-size:1.02rem; }
    .roll-card p{ margin:6px 0 0 0; color:#444; font-size:0.92rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .quantity-control { display:flex; align-items:center; gap:8px; }
    .quantity-control button {
      width:40px; height:36px; border-radius:8px; border:none; background:#f0c0c0; color:var(--accent); font-weight:800; cursor:pointer;
    }
    .quantity-control input { width:56px; text-align:center; border:1px solid #ddd; padding:6px; border-radius:6px; }

    /* panels */
    .panel { background:#fff; padding:12px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,0.04); margin-bottom:12px; }
    .panel-title { font-weight:800; color:var(--accent); margin-bottom:8px; }

    /* summary */
    #order-summary { background:#fafafa; padding:10px; border-radius:8px; min-height:140px; white-space:pre-wrap; font-family: "Courier New", monospace; }
    .actions-row { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }

    .note { color:#6b6b6b; font-size:0.92rem; margin-top:8px; }

    /* modals */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:40; padding:12px; }
    .modal .modal-content { background:#fff; padding:16px; border-radius:10px; width:100%; max-width:520px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
    .modal .modal-content h3{ margin:0 0 8px 0; }

    /* small tweaks */
    .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .btn.primary { background:var(--accent); color:#fff; }
    .btn.secondary { background:#fff; color:var(--accent); border:1px solid #ddd; }
    .btn.plain { background:transparent; color:#555; border:1px solid #eee; }
    .btn.danger { background:var(--danger); color:#fff; }

    /* make sauce selected visually */
    .sauce-selected { outline: 3px solid rgba(122,42,42,0.09); }

  </style>
</head>
<body>
  <div class="page">

    <!-- top auth row -->
    <div class="top-row">
      <div class="auth-wrap">
        <button id="auth-btn" class="auth-btn">×”×ª×—×‘×¨</button>
      </div>
    </div>

    <!-- logo large centered -->
    <div class="logo-row" aria-hidden="false">
      <!-- ×”×—×œ×£ ××ª src ×œ× ×ª×™×‘ ×”×œ×•×’×• ×©×œ×š ××• ×”×©××¨ ×›-is/placeholder -->
      <img src="https://via.placeholder.com/320x120?text=SUSHI+LOGO" alt="×œ×•×’×• ×¡×•×©×™" class="logo" id="site-logo">
    </div>

    <!-- categories row: single line -->
    <div class="categories-row" role="tablist" aria-label="×§×˜×’×•×¨×™×•×ª ×¡×•×©×™" id="categories-row">
      <!-- ×§×˜×’×•×¨×™×•×ª: ×›×œ ×”×›×¤×ª×•×¨×™× ×™×¦×•×¨×¤×•/××•×“×’×©×™× ×¢"×™ ×”-JS -->
    </div>

    <!-- main content -->
    <div class="main">
      <section class="menu-area" id="menu-area">
        <div id="insideout-rolls" class="category-container" aria-live="polite"></div>
        <div id="maki-rolls" class="category-container" style="display:none;"></div>
        <div id="onigiri-rolls" class="category-container" style="display:none;"></div>
        <div id="poke-rolls" class="category-container" style="display:none;"></div>
        <div id="oshizushi-rolls" class="category-container" style="display:none;"></div>
      </section>

      <aside class="side">
        <section class="panel">
          <div class="panel-title">×¨×˜×‘×™×</div>
          <div id="sauces-container" class="category-container"></div>
          <p class="note">×›×œ ×¨×•×œ ××§×‘×œ 2 ×¨×˜×‘×™× ×—×™× ×. ×¨×•×˜×‘ × ×•×¡×£ 3â‚ª.</p>
        </section>

        <section class="panel">
          <div class="panel-title">×›××•×ª ×¦'×•×¤×¡×˜×™×§×¡</div>
          <div class="quantity-control">
            <button id="chopsticks-minus">âˆ’</button>
            <input id="chopsticks-qty" type="number" readonly value="1">
            <button id="chopsticks-plus">+</button>
          </div>
        </section>

        <section class="panel">
          <div class="panel-title">×‘×—×¨ ×©×¢×ª ××™×¡×•×£</div>
          <select id="pickup-time"><option value="">×‘×—×¨ ×©×¢×”</option></select>
          <p class="note small" id="pickup-note"></p>
        </section>

        <section class="panel">
          <div class="panel-title">×”×¢×¨×•×ª ××™×©×™×•×ª</div>
          <textarea id="notes" placeholder="×œ×“×•×’××”: ×œ×œ× ×’×œ×•×˜×Ÿ, ×”×’×¢×” ×‘×©×¢×¨ 3..." rows="3"></textarea>
        </section>

        <section class="panel">
          <div class="panel-title">×¡×™×›×•× ×”×–×× ×”</div>
          <pre id="order-summary">×”×–×× ×” ×¨×™×§×” â€” ×‘×—×¨ ×¨×•×œ×™×, ×¨×˜×‘×™× ×•×©×¢×” ×œ×”×¦×’×ª ×”×¡×™×›×•×.</pre>
          <div class="actions-row">
            <button id="send-order" class="btn primary">×©×œ×— ×”×–×× ×”</button>
            <button id="guest-btn" class="btn secondary">×©×œ×— ×›××•×¨×—</button>
            <button id="view-orders" class="btn plain">×”×¦×’ ×”×™×¡×˜×•×¨×™×”</button>
          </div>
        </section>

        <div id="messages" aria-live="polite" style="margin-top:6px;"></div>
      </aside>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h3>×¤×¨×˜×™ ××©×ª××©</h3>
        <label>×©×</label>
        <input id="user-name" type="text">
        <label>××™××™×™×œ</label>
        <input id="user-email" type="email" readonly>
        <label>×˜×œ×¤×•×Ÿ</label>
        <input id="user-phone" type="text" placeholder="05XXXXXXXX">
        <div class="actions-row" style="margin-top:12px;">
          <button id="save-user" class="btn primary">×©××•×¨</button>
          <button id="logout-btn" class="btn danger">×”×ª× ×ª×§</button>
          <button id="close-profile" class="btn secondary">×¡×’×•×¨</button>
        </div>
      </div>
    </div>

    <!-- SEND CHOICE MODAL -->
    <div id="send-choice-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h3>×©×œ×™×—×ª ×”×–×× ×”</h3>
        <div class="actions-row">
          <button id="continue-login" class="btn primary">×”××©×š ×¢× Google</button>
          <button id="continue-guest" class="btn secondary">×©×œ×— ×›××•×¨×—</button>
          <button id="cancel-send" class="btn plain">×‘×™×˜×•×œ</button>
        </div>
        <div id="guest-phone-row" style="display:none; margin-top:12px;">
          <label>×˜×œ×¤×•×Ÿ ××•×¨×—</label>
          <input id="guest-phone" type="text" placeholder="05XXXXXXXX">
          <button id="guest-send-confirm" class="btn primary" style="margin-top:8px;">×©×œ×—</button>
        </div>
      </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="history-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h3>×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª</h3>
        <pre id="orders-list">×˜×•×¢×Ÿâ€¦</pre>
        <div class="actions-row" style="margin-top:8px;">
          <button id="close-history" class="btn secondary">×¡×’×•×¨</button>
        </div>
      </div>
    </div>

  </div>

  <script>
  /* ================== CONFIG / KEYS (TODO) ================== */
  const SUPABASE_URL = 'https://oxjokdjwdvmmdtcvqvon.supabase.co';
  const SUPABASE_KEY = ''; // TODO: ×× ×¨×•×¦×™× Supabase ××œ× â€” ×”×›× ×¡×• ×›××Ÿ ××ª ×”××¤×ª×—; ×× ×œ× â€” ×”×©××™×¨×• ×¨×™×§
  const GOOGLE_CLIENT_ID = ''; // TODO: ×”×›× ×¡ Google OAuth client id ×× ×¨×•×¦×™× Google Sign-In, ××—×¨×ª ×”×©××¨ ×¨×™×§
  const MAKE_WEBHOOK_URL = 'https://hook.eu2.make.com/asitqrbtyjum10ph3vf6gxhkd766us3r';

  const supabase = (typeof supabase !== 'undefined' && SUPABASE_KEY) ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

  /* ================== State ================== */
  let bookedTimes = JSON.parse(localStorage.getItem('bookedTimes') || '[]');
  let dailyRollCount = JSON.parse(localStorage.getItem('dailyRollCount') || '{}');
  let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  let chopsticksCount = 1;
  let selectedRolls = {};   // { rollId: qty }
  let selectedSauces = {};  // { sauceId: qty }

  /* ================== DATA â€” ××œ××™× ================== */
  const insideOutRollsData = [
    {id:"bingo", name:"×¨×•×œ ×‘×™× ×’×•", description:"×¡×œ××•×Ÿ × ×, ×©×× ×ª, ××‘×•×§×“×• ×‘×¦×™×¤×•×™ ×©×•××©×•× ×§×œ×•×™", price:50},
    {id:"luna", name:"×¨×•×œ ×œ×•× ×”", description:"×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ××¤×•×™ ×¢×œ ×¨×•×œ ×‘×˜×˜×”, ××‘×•×§×“×• ×•×©×™×˜××§×™", price:50},
    {id:"belgian", name:"×¨×•×œ ×¨×™×™", description:"×˜×¨×˜×¨ ×¡×¤×™×™×¡×™ ×˜×•× ×” × × ×¢×œ ×¨×•×œ ××œ×¤×¤×•×Ÿ, ×¢×™×¨×™×ª ×•××•×©×™× ×§×•", price:55},
    {id:"crazy-bruno", name:"×¨×•×œ ×§×¨×™×™×–×™ ×‘×¨×•× ×•", description:"×“×’ ×œ×‘×Ÿ, ×˜×•× ×”, ×¡×œ××•×Ÿ ×‘×¦×™×¤×•×™ ×©×•××©×•× ×§×œ×•×™", price:60},
    {id:"happy-bruno", name:"×¨×•×œ ×”××¤×™ ×‘×¨×•× ×•", description:"×¡×œ××•×Ÿ ×‘×¦×™×¤×•×™ ×©×§×“×™× ×§×œ×•×™×™× ×•×¨×•×˜×‘ ×˜×¨×™××§×™", price:60},
    {id:"mila", name:"×¨×•×œ ××™×œ×”", description:"×‘×˜×˜×”, ×¢×™×¨×™×ª ×•××‘×•×§×“×• ×‘×¢×™×˜×•×£ ×¡×œ××•×Ÿ ×¦×¨×•×‘", price:50},
    {id:"newton", name:"×¨×•×œ × ×™×•×˜×•×Ÿ", description:"×˜×•× ×” ××“×•××”, ××‘×•×§×“×•, ×‘×˜×˜×” ×‘×¦×™×¤×•×™ ×¤× ×§×• ×•×¨×•×˜×‘ ×‘×•×˜× ×™×", price:55},
    {id:"oli", name:"×¨×•×œ ××•×œ×™", description:"×“×’ ×œ×‘×Ÿ, ××œ×¤×¤×•×Ÿ, ××‘×•×§×“×• ×‘×¦×™×¤×•×™ ×©×•××©×•×", price:50},
    {id:"milli", name:"×¨×•×œ ××™×œ×™", description:"××§×œ ×¡×•×¨×™××™, ×“×’ ×œ×‘×Ÿ ××¤×•×™, ××•×©×™× ×§×• ×‘×¦×™×¤×•×™ ×¤× ×§×•", price:50},
    {id:"scar", name:"×¨×•×œ ×¡×§××¨", description:"×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ××¤×•×™ ×¢× ××‘×•×§×“×•, ××œ×¤×¤×•×Ÿ ×•×‘×˜×˜×” ×‘×¢×™×˜×•×¨ ××™×•× ×– ×•×¦'×™×¤×¡", price:50},
    {id:"magi", name:"×¨×•×œ ××’×™ğŸŒ±", description:"××œ×¤×¤×•×Ÿ, ×‘×˜×˜×”, ×¢×™×¨×™×ª ×•××‘×•×§×“×• ×‘×¢×™×˜×•×¨ ×‘×˜×˜×” ×•×¨×•×˜×‘ ×‘×•×˜× ×™×", price:40},
    {id:"tyson", name:"×¨×•×œ ×˜×™×™×¡×•×Ÿ ×•×§×™×™×œ×”", description:"×¡×œ××•×Ÿ × ×, ×§× ×¤×™×•, ×‘×˜×˜×” ×‘×¢×™×˜×•×£ ×©×‘×‘×™ ×¤× ×§×• ×¡×’×•×œ", price:50},
    {id:"lucy", name:"×¨×•×œ ×œ×•×¡×™", description:"×¡×œ××•×Ÿ × ×, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™ ×•××•×©×™× ×§×• ×‘×¦×™×¤×•×™ ×˜×•×‘×™×§×•", price:55},
    {id:"billy", name:"×¨×•×œ ×‘×™×œ×™", description:"×“×’ ×œ×‘×Ÿ ×¦×¨×•×‘, ×¢×™×¨×™×ª, ×‘×˜×˜×” ××¦×•×¤×” ×‘×¤× ×§×•", price:50},
    {id:"lucky", name:"×¨×•×œ ×œ××§×™", description:"×˜×¨×˜×¨ ×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ×¢× ××‘×•×§×“×•, ××œ×¤×¤×•×Ÿ ×•×¢×™×¨×™×ª", price:50}
  ];

  const makiRollsData = [
    {id:"alfi", name:"×¨×•×œ ××œ×¤×™", description:"×××§×™ ×¡×œ××•×Ÿ", price:35},
    {id:"maymay", name:"×¨×•×œ ××™×™ ××™×™ğŸŒ±", description:"×××§×™ ×‘×˜×˜×” ×•××‘×•×§×“×•", price:25},
    {id:"snoopy", name:"×¨×•×œ ×¡× ×•×¤×™ğŸŒ±", description:"×××§×™ ××•×©×™× ×§×• ×•×§× ×¤×™×•", price:25}
  ];

  const onigiriData = [
    {id:"rocky", name:"××•× ×™×’×™×¨×™ ×¨×•×§×™", description:"×˜×¨×˜×¨ ×˜×•× ×” ××“×•××” ×¢× ×¡×¤×™×™×¡×™ ××™×•× ×– ×•×‘×¦×œ ×™×¨×•×§", price:35},
    {id:"johnny", name:"××•× ×™×’×™×¨×™ ×’×³×•× ×™", description:"×˜×¨×˜×¨ ×¡×œ××•×Ÿ ×¢× ×¡×¤×™×™×¡×™ ××™×•× ×– ×•×‘×¦×œ ×™×¨×•×§", price:30},
    {id:"gisel", name:"××•× ×™×’×™×¨×™ ×’×³×™×–×œğŸŒ±", description:"××‘×•×§×“×• ×•×‘×˜×˜×”", price:25}
  ];

  const pokeData = [
    {id:"dog", name:"×‘×•×œ-×“×•×’", description:"××•×¨×– ×¡×•×©×™, ×¡×œ××•×Ÿ ×‘××¨×™× ×“×”, ××“×××”, ××œ×¤×¤×•×Ÿ, ××‘×•×§×“×•, ×‘×¦×œ ×™×¨×•×§. ××¢×œ ×©×•××©×•× ×•×¨×•×˜×‘ ×¡×¤×™×™×¡×™ ××™×•× ×–", price:60},
    {id:"pit", name:"×¤×™×˜-×‘×•×œ", description:"××•×¨×– ×¡×•×©×™, ×˜×•× ×” ×‘××¨×™× ×“×”, ××“×××”, ×× ×’×•, ×›×¨×•×‘ ×¡×’×•×œ, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™. ××¢×œ ×‘×¦×œ ×©××œ×•×˜ ××˜×•×’×Ÿ ×•×¨×•×˜×‘ ×× × ×¡ ××ª×•×§", price:70},
    {id:"trir", name:"×‘×•×œ-×˜×¨×™×™×¨ğŸŒ±", description:"××•×¨×– ×¡×•×©×™, ××“×××”, ××œ×¤×¤×•×Ÿ, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™, ×’×–×¨ ×•××‘×•×§×“×•. ××¢×œ ×©×•××©×•× ×•×¨×•×˜×‘ ×‘×•×˜× ×™×", price:45}
  ];

  const oshizushiData = [
    {id:"oshi-salmon", name:"××•×©×™ ×¡×œ××•×Ÿ", description:"××•×©×™ ×¤×¨×•×¡×•×ª ×¡×œ××•×Ÿ ×¦×¨×•×‘ ××¢×œ ××•×¨×– ×“×—×•×¡", price:65},
    {id:"oshi-tuna", name:"××•×©×™ ×˜×•× ×”", description:"××•×©×™ ×¢× ×˜×¨×˜×¨ ×˜×•× ×” ×•××’×•×–×™ ×¡×™×™×©×•", price:68},
    {id:"oshi-vege", name:"××•×©×™ ×™×¨×§×•×ªğŸŒ±", description:"××•×©×™ ×¢× ×™×¨×§×•×ª ×›×‘×•×©×™× ×•××‘×•×§×“×•", price:50}
  ];

  const saucesData = [
    {id:"spicy-mayo", name:"×¡×¤×™×™×¡×™ ××™×•× ×–", price:3},
    {id:"soy", name:"×¨×•×˜×‘ ×¡×•×™×”", price:3},
    {id:"teriyaki", name:"×¨×•×˜×‘ ×˜×¨×™××§×™", price:3},
    {id:"ginger", name:"×’×³×™× ×’×³×¨", price:3},
    {id:"wasabi", name:"×•×•××¡××‘×™", price:3}
  ];

  /* ================== HELPERS ================== */
  function $id(id){ return document.getElementById(id); }
  function showMessage(txt, isError = true){
    const m = $id('messages');
    if(!m) return;
    m.textContent = txt;
    m.style.color = isError ? '#b71c1c' : '#2a7a2a';
    setTimeout(()=>{ if(m.textContent === txt) m.textContent = ''; }, 6000);
  }
  function generateUUID(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c){ const r = Math.random()*16|0; const v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }

  /* ================== RENDER / UI ================== */
  const categories = [
    {id:'insideout-rolls', label:'Inside-out'},
    {id:'maki-rolls', label:'Maki'},
    {id:'onigiri-rolls', label:'Onigiri'},
    {id:'poke-rolls', label:'Poke'},
    {id:'oshizushi-rolls', label:'Oshizushi'}
  ];

  function renderCategoryTabs(){
    const wrap = $id('categories-row');
    wrap.innerHTML = '';
    categories.forEach((c, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'cat-btn' + (idx===0 ? ' active' : '');
      btn.textContent = c.label;
      btn.dataset.target = c.id;
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        // show only target container
        categories.forEach(cc=>{
          const el = $id(cc.id);
          if(!el) return;
          el.style.display = (cc.id === c.id) ? 'flex' : 'none';
        });
      });
      wrap.appendChild(btn);
    });
  }

  function createRollCard(item, containerId){
    const container = $id(containerId);
    if(!container) return;
    const card = document.createElement('div');
    card.className = 'roll-card';
    const info = document.createElement('div'); info.className='info';
    info.innerHTML = `<h3>${item.name} â€” ${item.price}â‚ª</h3><p title="${item.description}">${item.description}</p>`;
    const controls = document.createElement('div'); controls.className='quantity-control';
    const btnMinus = document.createElement('button'); btnMinus.textContent='âˆ’';
    const inputQty = document.createElement('input'); inputQty.type='number'; inputQty.readOnly = true; inputQty.value = selectedRolls[item.id] || 0;
    const btnPlus = document.createElement('button'); btnPlus.textContent='+';
    btnPlus.addEventListener('click', ()=>{
      selectedRolls[item.id] = (selectedRolls[item.id]||0) + 1;
      inputQty.value = selectedRolls[item.id];
      updateSummary();
    });
    btnMinus.addEventListener('click', ()=>{
      if((selectedRolls[item.id]||0) > 0){
        selectedRolls[item.id]--;
        inputQty.value = selectedRolls[item.id];
        updateSummary();
      }
    });
    controls.append(btnMinus, inputQty, btnPlus);
    card.append(info, controls);
    container.appendChild(card);
  }

  function createSauceCard(item){
    const container = $id('sauces-container');
    if(!container) return;
    const card = document.createElement('div');
    card.className = 'roll-card';
    const info = document.createElement('div'); info.className='info';
    info.innerHTML = `<h3>${item.name}</h3><p>2 ×—×™× × ×œ×›×œ ×¨×•×œ â€” ××¢×‘×¨ ×œ×›×š ${item.price}â‚ª</p>`;
    const controls = document.createElement('div'); controls.className='quantity-control';
    const btnMinus = document.createElement('button'); btnMinus.textContent='âˆ’';
    const inputQty = document.createElement('input'); inputQty.type='number'; inputQty.readOnly=true; inputQty.value = selectedSauces[item.id]||0;
    const btnPlus = document.createElement('button'); btnPlus.textContent='+';
    btnPlus.addEventListener('click', ()=>{
      selectedSauces[item.id] = (selectedSauces[item.id]||0) + 1;
      inputQty.value = selectedSauces[item.id];
      updateSummary();
    });
    btnMinus.addEventListener('click', ()=>{
      if((selectedSauces[item.id]||0) > 0){
        selectedSauces[item.id]--;
        inputQty.value = selectedSauces[item.id];
        updateSummary();
      }
    });
    controls.append(btnMinus, inputQty, btnPlus);
    card.append(info, controls);
    container.appendChild(card);
  }

  function initMenu(){
    // clear containers
    ['insideout-rolls','maki-rolls','onigiri-rolls','poke-rolls','oshizushi-rolls'].forEach(id=>{
      const el = $id(id); if(el) el.innerHTML = '';
    });
    // fill
    insideOutRollsData.forEach(r => createRollCard(r, 'insideout-rolls'));
    makiRollsData.forEach(r => createRollCard(r, 'maki-rolls'));
    onigiriData.forEach(r => createRollCard(r, 'onigiri-rolls'));
    pokeData.forEach(r => createRollCard(r, 'poke-rolls'));
    oshizushiData.forEach(r => createRollCard(r, 'oshizushi-rolls'));
    // sauces
    $id('sauces-container').innerHTML = '';
    saucesData.forEach(s => createSauceCard(s));
  }

  /* ================== PICKUP TIMES ================== */
  function initPickupTimes(){
    const sel = $id('pickup-time');
    if(!sel) return;
    sel.innerHTML = '<option value="">×‘×—×¨ ×©×¢×”</option>';
    for(let h=19; h<=22; h++){
      for(const m of [0,30]){
        if(h===22 && m>30) continue;
        const label = `${String(h).padStart(2,'0')}:${m===0?'00':'30'}`;
        if(bookedTimes.includes(label)) continue;
        const opt = document.createElement('option'); opt.value = label; opt.textContent = label;
        sel.appendChild(opt);
      }
    }
    $id('pickup-note').textContent = bookedTimes.length ? `×™×© ×›×‘×¨ ${bookedTimes.length} ×©×¢×•×ª ×ª×¤×•×¡×•×ª` : '';
  }

  /* ================== SUMMARY ================== */
  function computeSummaryObject(){
    const all = [...insideOutRollsData,...makiRollsData,...onigiriData,...pokeData,...oshizushiData];
    let total = 0;
    let totalRolls = 0;
    const rolls = [];
    for(const id in selectedRolls){
      const qty = selectedRolls[id]||0;
      if(qty<=0) continue;
      const item = all.find(x=>x.id===id);
      if(!item) continue;
      rolls.push({ id: item.id, name: item.name, qty, unitPrice: item.price, lineTotal: item.price * qty });
      total += item.price * qty;
      totalRolls += qty;
    }

    const sauces = [];
    let usedSaucesCount = 0;
    for(const id in selectedSauces){
      const qty = selectedSauces[id]||0;
      if(qty<=0) continue;
      const s = saucesData.find(x=>x.id===id);
      if(!s) continue;
      sauces.push({ id: s.id, name: s.name, qty, unitPrice: s.price });
      usedSaucesCount += qty;
    }

    const freeSauces = totalRolls * 2;
    const extraSauces = Math.max(0, usedSaucesCount - freeSauces);
    const extraSauceCost = extraSauces * 3;
    total += extraSauceCost;

    return { rolls, sauces, totalRolls, usedSaucesCount, freeSauces, extraSauces, extraSauceCost, total };
  }

  function updateSummary(){
    const s = computeSummaryObject();
    let text = `×”×–×× ×” ×—×“×©×”:\n\n`;
    if(s.rolls.length){
      s.rolls.forEach(r => text += `${r.name} x${r.qty} â€” ${r.lineTotal}â‚ª\n`);
      text += '\n';
    } else text += '(×œ× × ×‘×—×¨×• ×¨×•×œ×™×)\n\n';

    text += '×¨×˜×‘×™×:\n';
    if(s.sauces.length) s.sauces.forEach(su => text += `${su.name} x${su.qty}\n`);
    else text += '(×œ× × ×‘×—×¨×• ×¨×˜×‘×™×)\n';

    if(s.extraSauces > 0) text += `\n×¢×œ×•×ª ×¨×˜×‘×™× × ×•×¡×¤×™×: ${s.extraSauces} Ã— 3â‚ª = ${s.extraSauceCost}â‚ª\n`;

    text += `\n×›××•×ª ×¦'×•×¤×¡×˜×™×§×¡: ${chopsticksCount}\n`;
    const notes = $id('notes') ? $id('notes').value.trim() : '';
    if(notes) text += `\n×”×¢×¨×•×ª: ${notes}\n`;
    const pickup = $id('pickup-time') ? $id('pickup-time').value : '';
    text += `\n×©×¢×ª ××™×¡×•×£: ${pickup || '(×œ× × ×‘×—×¨×”)'}\n`;
    if(currentUser) text += `\n×œ×§×•×—: ${currentUser.name} (${currentUser.email||currentUser.phone||'××•×¨×—'})\n`;
    text += `\n×¡×”"×› ×œ×ª×©×œ×•×: ${s.total}â‚ª\n`;

    if($id('order-summary')) $id('order-summary').textContent = text;
    if($id('send-order')) $id('send-order').disabled = !(s.totalRolls > 0 && !!pickup);
  }

  /* ================== UI EVENTS ================== */
  function setupTabsAndInputs(){
    renderCategoryTabs();
    // show first category by default
    categories.forEach((c, idx)=>{
      const el = $id(c.id);
      if(!el) return;
      el.style.display = idx===0 ? 'flex' : 'none';
      el.style.flexDirection = 'column';
    });

    $id('chopsticks-plus').addEventListener('click', ()=>{ chopsticksCount++; $id('chopsticks-qty').value = chopsticksCount; updateSummary(); });
    $id('chopsticks-minus').addEventListener('click', ()=>{ if(chopsticksCount>1) chopsticksCount--; $id('chopsticks-qty').value = chopsticksCount; updateSummary(); });
    if($id('pickup-time')) $id('pickup-time').addEventListener('change', updateSummary);
    if($id('notes')) $id('notes').addEventListener('input', updateSummary);
  }

  /* ================== AUTH & PROFILE ================== */
  function openModal(id){ const m = $id(id); if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); } }
  function closeModal(id){ const m = $id(id); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }

  $id('profile-btn')?.addEventListener('click', ()=>{
    if(!currentUser){
      if(GOOGLE_CLIENT_ID){
        google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse, ux_mode:'popup' });
        google.accounts.id.prompt();
      } else {
        showMessage('××™×Ÿ Google Client ID â€“ ×”×ª×—×‘×¨ ×›××•×¨×— ××• ×”×•×¡×£ Google ID ×‘×§×•×‘×¥.', true);
      }
      return;
    }
    openModal('profile-modal');
    $id('user-name').value = currentUser.name || '';
    $id('user-email').value = currentUser.email || '';
    $id('user-phone').value = currentUser.phone || '';
  });

  $id('close-profile')?.addEventListener('click', ()=> closeModal('profile-modal'));

  $id('auth-btn')?.addEventListener('click', ()=>{
    if(currentUser){
      // logout
      currentUser = null;
      localStorage.removeItem('currentUser');
      updateAuthUI();
      showMessage('×”×ª× ×ª×§×ª', false);
      return;
    }
    if(GOOGLE_CLIENT_ID){
      google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse, ux_mode:'popup' });
      google.accounts.id.prompt();
    } else {
      // offer guest modal if no Google configured
      openModal('send-choice-modal');
    }
  });

  window.handleCredentialResponse = function(response){
    try{
      const decoded = jwt_decode(response.credential);
      currentUser = { name: decoded.name || decoded.given_name || '', email: decoded.email || '', phone: '' };
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      updateAuthUI();
      showMessage(`×©×œ×•× ${currentUser.name}`, false);
      openModal('profile-modal');
      $id('user-name').value = currentUser.name || '';
      $id('user-email').value = currentUser.email || '';
    } catch(e){
      console.error(e);
      showMessage('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª Google', true);
    }
  };

  $id('save-user')?.addEventListener('click', ()=>{
    if(!currentUser) currentUser = {};
    currentUser.name = $id('user-name').value.trim();
    currentUser.phone = $id('user-phone').value.trim();
    if(currentUser.phone && !/^05\d{8}$/.test(currentUser.phone)){ showMessage('×¤×•×¨××˜ ×˜×œ×¤×•×Ÿ ××™× ×• ×ª×§×™×Ÿ (05XXXXXXXX)', true); return; }
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    closeModal('profile-modal');
    updateAuthUI();
    showMessage('×¤×¨×˜×™ ××©×ª××© × ×©××¨×•', false);
    updateSummary();
  });

  $id('logout-btn')?.addEventListener('click', ()=>{
    currentUser = null;
    localStorage.removeItem('currentUser');
    updateAuthUI();
    closeModal('profile-modal');
    showMessage('×”×ª× ×ª×§×ª', false);
  });

  function updateAuthUI(){
    const authBtn = $id('auth-btn');
    if(currentUser){
      if(authBtn) authBtn.textContent = '×”×ª× ×ª×§';
    } else {
      if(authBtn) authBtn.textContent = '×”×ª×—×‘×¨';
    }
    updateSummary();
  }

  /* ================== SEND FLOW ================== */
  $id('send-order')?.addEventListener('click', ()=>{
    if(!currentUser){
      openModal('send-choice-modal');
      return;
    }
    performSend();
  });

  $id('guest-btn')?.addEventListener('click', ()=> openModal('send-choice-modal'));
  $id('cancel-send')?.addEventListener('click', ()=> closeModal('send-choice-modal'));
  $id('continue-login')?.addEventListener('click', ()=> {
    if(GOOGLE_CLIENT_ID){
      google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse, ux_mode:'popup' });
      google.accounts.id.prompt();
    } else showMessage('××™×Ÿ Google Client ID', true);
  });
  $id('continue-guest')?.addEventListener('click', ()=> { if($id('guest-phone-row')) $id('guest-phone-row').style.display = 'block'; });
  $id('guest-send-confirm')?.addEventListener('click', async ()=>{
    const phone = $id('guest-phone').value.trim();
    if(!/^05\d{8}$/.test(phone)){ showMessage('×× × ×”×›× ×¡ ×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ (05XXXXXXXX)', true); return; }
    const prevUser = currentUser;
    currentUser = { name: '××•×¨×—', email:'', phone };
    await performSend();
    currentUser = prevUser;
    closeModal('send-choice-modal');
  });

  async function performSend(){
    const s = computeSummaryObject();
    if(s.totalRolls === 0){ showMessage('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×¨×•×œ ××—×“', true); return; }
    const pickup = $id('pickup-time').value;
    if(!pickup){ showMessage('×™×© ×œ×‘×—×•×¨ ×©×¢×ª ××™×¡×•×£', true); return; }

    const today = new Date().toISOString().slice(0,10);
    const todayCount = dailyRollCount[today] || 0;
    if(todayCount + s.totalRolls > 15){ showMessage(`×œ× × ×™×ª×Ÿ ×œ×”×–××™×Ÿ â€” ×”×•×©×’×• ×›×‘×¨ ${todayCount} ×¨×•×œ×™× ×”×™×•× (××§×¡×™××•× 15).`, true); return; }

    if(bookedTimes.includes(pickup)){ showMessage('×”×©×¢×” ×ª×¤×•×¡×”, ×‘×—×¨ ×©×¢×” ××—×¨×ª', true); initPickupTimes(); return; }

    const orderUUID = generateUUID();
    const payload = {
      id: orderUUID,
      timestamp: new Date().toISOString(),
      user: currentUser || { name:'××•×¨×—', email:'', phone:'' },
      pickupTime: pickup,
      chopsticks: chopsticksCount,
      notes: $id('notes').value.trim(),
      rolls: s.rolls,
      sauces: s.sauces,
      summary: $id('order-summary').textContent,
      total: s.total
    };

    try{
      // send to Make (best-effort)
      try { await fetch(MAKE_WEBHOOK_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }); }
      catch(e){ console.warn('Make webhook error', e); }

      // Supabase insert if configured
      if(supabase){
        const { error } = await supabase.from('orders').insert([{
          id: payload.id,
          created_at: payload.timestamp,
          user_name: payload.user.name,
          user_email: payload.user.email || '',
          user_phone: payload.user.phone || '',
          pickup_time: payload.pickupTime,
          notes: payload.notes,
          rolls: payload.rolls,
          sauces: payload.sauces,
          chopsticks_count: payload.chopsticks,
          total: payload.total,
          summary: payload.summary
        }]);
        if(error){ console.error('Supabase insert error', error); showMessage('×©×’×™××” ×‘×©××™×¨×” ×œ-DB', true); return; }
      }

      // update local
      bookedTimes.push(pickup); localStorage.setItem('bookedTimes', JSON.stringify(bookedTimes));
      dailyRollCount[today] = (dailyRollCount[today] || 0) + s.totalRolls; localStorage.setItem('dailyRollCount', JSON.stringify(dailyRollCount));

      showMessage('×”×”×–×× ×” × ×©×œ×—×” ×•× ×©××¨×” ×‘×”×¦×œ×—×”!', false);

      // reset
      selectedRolls = {}; selectedSauces = {}; chopsticksCount = 1;
      if($id('chopsticks-qty')) $id('chopsticks-qty').value = 1;
      if($id('notes')) $id('notes').value = '';
      if($id('pickup-time')) $id('pickup-time').value = '';

      initMenu(); initPickupTimes(); updateSummary();
    } catch(err){
      console.error(err); showMessage('×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×”', true);
    }
  }

  /* ================== HISTORY VIEW ================== */
  $id('view-orders')?.addEventListener('click', async ()=>{
    if(!currentUser || (!currentUser.email && !currentUser.phone)){ showMessage('××™×Ÿ ×¤×¨×˜×™ ××©×ª××© ×›×“×™ ×œ××¦×•× ×”×™×¡×˜×•×¨×™×”', true); return; }
    openModal('history-modal');
    $id('orders-list').textContent = '×˜×•×¢×Ÿâ€¦';
    if(!supabase){ $id('orders-list').textContent = '××™×Ÿ ×—×™×‘×•×¨ ×œ-Supabase (××¤×ª×— ×œ× ×”×•×–×Ÿ).'; return; }
    try{
      let query = supabase.from('orders').select('*').order('created_at', { ascending:false });
      if(currentUser.email) query = query.eq('user_email', currentUser.email);
      else query = query.eq('user_phone', currentUser.phone);
      const { data, error } = await query;
      if(error){ console.error(error); $id('orders-list').textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×™×¡×˜×•×¨×™×”'; return; }
      if(!data || data.length === 0){ $id('orders-list').textContent = '××™×Ÿ ×”×–×× ×•×ª ×§×•×“××•×ª'; return; }
      $id('orders-list').textContent = data.map(o => `${o.created_at}\n${o.summary}`).join('\n\nâ€”â€“\n\n');
    } catch(e){
      console.error(e); $id('orders-list').textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×™×¡×˜×•×¨×™×”';
    }
  });
  $id('close-history')?.addEventListener('click', ()=> closeModal('history-modal'));

  /* ================== INIT ================== */
  window.addEventListener('DOMContentLoaded', ()=>{
    // daily reset at midnight (local)
    const today = new Date().toISOString().slice(0,10);
    if(localStorage.getItem('lastResetDate') !== today){
      bookedTimes = []; dailyRollCount = {}; localStorage.setItem('bookedTimes', JSON.stringify(bookedTimes)); localStorage.setItem('dailyRollCount', JSON.stringify(dailyRollCount)); localStorage.setItem('lastResetDate', today);
    } else {
      bookedTimes = JSON.parse(localStorage.getItem('bookedTimes')||'[]');
      dailyRollCount = JSON.parse(localStorage.getItem('dailyRollCount')||'{}');
      currentUser = JSON.parse(localStorage.getItem('currentUser')||'null');
    }

    renderCategoryTabs();
    initMenu();
    initPickupTimes();
    setupTabsAndInputs();
    updateSummary();
    updateAuthUI();

    // default first tab show
    const firstTab = document.querySelectorAll('.cat-btn')[0];
    if(firstTab) firstTab.click();

    // close modals on outside click
    document.querySelectorAll('.modal').forEach(modal=>{
      modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display = 'none'; });
    });
  });

  </script>
</body>
</html>
