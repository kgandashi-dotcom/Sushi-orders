<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>סושי הזמנה</title>
<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f5f4;color:#222;}
header{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px;}
header .logo{width:120px;height:auto;}
.tabs-row{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;}
.tab{padding:8px 12px;border-radius:8px;background:#fff;border:1px solid #eee;cursor:pointer;font-weight:700;}
.tab.active{background:#7a2a2a;color:#fff;border-color:#5e1b1b;}
.user-actions{position:absolute;top:12px;left:12px;}
.user-actions .btn{padding:8px 12px;border:none;border-radius:8px;font-weight:700;cursor:pointer;}
.btn.primary{background:#7a2a2a;color:#fff;}
.btn.secondary{background:#fff;color:#7a2a2a;border:1px solid #ddd;}
main{display:flex;flex-direction:column;gap:12px;padding:12px;}
.category-container{display:flex;flex-direction:column;gap:10px;padding:6px 0;}
.roll-card{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px;border-radius:10px;background:#fff;box-shadow:0 4px 14px rgba(0,0,0,0.05);}
.quantity-control{display:flex;align-items:center;gap:8px;}
.quantity-control button{width:36px;height:36px;border:none;border-radius:8px;background:#f0c0c0;color:#7a2a2a;font-weight:700;font-size:1.2rem;cursor:pointer;}
.quantity-control input{width:56px;text-align:center;border:1px solid #ddd;padding:6px;border-radius:6px;}
.panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,0.04);margin-bottom:12px;}
.panel-title{font-weight:800;color:#7a2a2a;margin-bottom:8px;}
#order-summary{background:#fafafa;padding:10px;border-radius:8px;min-height:120px;white-space:pre-wrap;font-family:"Courier New",monospace;}
textarea#notes{width:100%;height:80px;border:1px solid #ddd;border-radius:6px;padding:6px;}
@media(max-width:980px){.tabs-row{flex-wrap:wrap;}.quantity-control input{width:40px;}}
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
</head>
<body>

<header>
  <div class="user-actions">
    <button id="profile-btn" class="btn primary">התחבר</button>
  </div>
  <img src="https://i.imgur.com/m6KeXAB.jpeg" alt="לוגו" class="logo">
  <div class="tabs-row">
    <button class="tab active" data-target="insideout-rolls">Inside-out</button>
    <button class="tab" data-target="maki-rolls">Maki</button>
    <button class="tab" data-target="onigiri-rolls">Onigiri</button>
    <button class="tab" data-target="poke-rolls">Poke</button>
    <button class="tab" data-target="oshizushi-rolls">Oshizushi</button>
  </div>
</header>

<main>
  <section id="menu-area">
    <div id="insideout-rolls" class="category-container"></div>
    <div id="maki-rolls" class="category-container" style="display:none;"></div>
    <div id="onigiri-rolls" class="category-container" style="display:none;"></div>
    <div id="poke-rolls" class="category-container" style="display:none;"></div>
    <div id="oshizushi-rolls" class="category-container" style="display:none;"></div>
  </section>

  <aside id="side-area">
    <section class="panel">
      <div class="panel-title">רטבים (2 חינם לכל רול)</div>
      <div id="sauces-container" class="category-container"></div>
    </section>

    <section class="panel">
      <div class="panel-title">כמות צ'ופסטיקס</div>
      <div class="quantity-control">
        <button id="chopsticks-minus">−</button>
        <input id="chopsticks-qty" type="number" readonly value="1">
        <button id="chopsticks-plus">+</button>
      </div>
    </section>

    <section class="panel">
      <div class="panel-title">בחר שעת איסוף</div>
      <select id="pickup-time"><option value="">בחר שעה</option></select>
    </section>

    <section class="panel">
      <div class="panel-title">הערות אישיות</div>
      <textarea id="notes" placeholder="לדוגמה: ללא גלוטן, הגעה בשער 3..."></textarea>
    </section>

    <section class="panel">
      <div class="panel-title">סיכום הזמנה</div>
      <pre id="order-summary">הזמנה ריקה — בחר רולים, רטבים ושעה להצגת הסיכום.</pre>
      <div class="actions-row">
        <button id="send-order" class="btn primary">שלח הזמנה</button>
      </div>
      <div id="messages" aria-live="polite" style="color:#b71c1c;font-weight:700;margin-top:8px;"></div>
    </section>
  </aside>
</main>

<script>
const SUPABASE_URL='https://oxjokdjwdvmmdtcvqvon.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9rZGp3ZHZtbWR0Y3Zxdm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzgwMzMsImV4cCI6MjA3NDY1NDAzM30.DmKp79UiPi9iOU50UutevdqRcPyREMUJ7NT5ZmBHDsg';
const MAKE_WEBHOOK_URL='https://hook.eu2.make.com/asitqrbtyjum10ph3vf6gxhkd766us3r';
const GOOGLE_CLIENT_ID='962297663657-7bsrugivo5rjbu534lamiuc256gbqoc4.apps.googleusercontent.com';
let currentUser=null, chopsticksCount=1, selectedRolls={};

// ================== DATA ==================
const insideOutRollsData=[
  {id:"bingo",name:"רול בינגו - 50₪",description:"סלמון נא, שמנת, אבוקדו בציפוי שומשום קלוי",price:50},
  {id:"luna",name:"רול לונה - 50₪",description:"ספייסי סלמון אפוי על רול בטטה, אבוקדו ושיטאקי",price:50},
  {id:"dragon",name:"רול דרגון - 55₪",description:"טייגר רול עם סלמון, אבוקדו, שמנת",price:55}
];
const makiRollsData=[
  {id:"alfi",name:"רול אלפי - 35₪",description:"מאקי סלמון",price:35},
  {id:"veggie",name:"רול ירקות - 30₪",description:"מאקי עם ירקות טריים",price:30}
];
const onigiriData=[
  {id:"rocky",name:"אוניגירי רוקי - 35₪",description:"טרטר טונה אדומה עם ספייסי מיונז ובצל ירוק",price:35},
  {id:"salmon",name:"אוניגירי סלמון - 30₪",description:"אוניגירי עם סלמון נא",price:30}
];
const pokeData=[
  {id:"dog",name:"בול-דוג - 60₪",description:"אורז סושי, סלמון במרינדה, אדממה, מלפפון, אבוקדו, בצל ירוק. מעל שומשום ורוטב ספייסי מיונז",price:60},
  {id:"tuna",name:"בול-טונה - 65₪",description:"טונה אדומה, אבוקדו, אדממה, מלפפון, רוטב סויה",price:65}
];
const oshizushiData=[
  {id:"oshi1",name:"אושי-סושי 1 - 55₪",description:"סלמון, אורז, אבוקדו בצורת אושי",price:55},
  {id:"oshi2",name:"אושי-סושי 2 - 60₪",description:"טונה אדומה, אורז, ירקות טריים",price:60}
];
const saucesData=[
  {id:"spicy-mayo",name:"ספייסי מיונז"},
  {id:"teriyaki",name:"טריאקי"},
  {id:"ginger-wasabi",name:"ג'ינג'ר וואסאבי"}
];

// ================== INITIALIZATION ==================
function populateRolls(){
  const categories=[{el:document.getElementById('insideout-rolls'),data:insideOutRollsData},
                    {el:document.getElementById('maki-rolls'),data:makiRollsData},
                    {el:document.getElementById('onigiri-rolls'),data:onigiriData},
                    {el:document.getElementById('poke-rolls'),data:pokeData},
                    {el:document.getElementById('oshizushi-rolls'),data:oshizushiData}];
  categories.forEach(cat=>{
    cat.data.forEach(roll=>{
      const div=document.createElement('div');
      div.className='roll-card';
      div.innerHTML=`<div><strong>${roll.name}</strong><br>${roll.description}</div>
      <div class="quantity-control">
        <button data-roll="${roll.id}" class="minus">−</button>
        <input type="number" value="0" readonly data-roll="${roll.id}">
        <button data-roll="${roll.id}" class="plus">+</button>
      </div>`;
      cat.el.appendChild(div);
    });
  });
}

function populateSauces(){
  const container=document.getElementById('sauces-container');
  saucesData.forEach(s=>{
    const div=document.createElement('div');
    div.textContent=s.name;
    container.appendChild(div);
  });
}

function populateTimes(){
  const sel=document.getElementById('pickup-time');
  for(let h=19;h<=22;h++){
    const mMax=(h===22)?30:59;
    for(let m=0;m<=mMax;m+=30){
      const val=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
      const opt=document.createElement('option');
      opt.value=val; opt.textContent=val;
      sel.appendChild(opt);
    }
  }
}

// ================== EVENT LISTENERS ==================
document.addEventListener('DOMContentLoaded',()=>{
  populateRolls();
  populateSauces();
  populateTimes();
  
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.category-container').forEach(c=>c.style.display='none');
      document.getElementById(tab.dataset.target).style.display='flex';
    });
  });

  document.querySelectorAll('.plus').forEach(btn=>{
    btn.addEventListener('click',e=>{
      const rollId=e.target.dataset.roll;
      const input=document.querySelector(`input[data-roll="${rollId}"]`);
      input.value=parseInt(input.value)+1;
      selectedRolls[rollId]=(selectedRolls[rollId]||0)+1;
      updateSummary();
    });
  });
  document.querySelectorAll('.minus').forEach(btn=>{
    btn.addEventListener('click',e=>{
      const rollId=e.target.dataset.roll;
      const input=document.querySelector(`input[data-roll="${rollId}"]`);
      if(parseInt(input.value)>0){
        input.value=parseInt(input.value)-1;
        selectedRolls[rollId]--;
        if(selectedRolls[rollId]<=0) delete selectedRolls[rollId];
        updateSummary();
      }
    });
  });

  document.getElementById('chopsticks-plus').addEventListener('click',()=>{
    chopsticksCount++; document.getElementById('chopsticks-qty').value=chopsticksCount;
  });
  document.getElementById('chopsticks-minus').addEventListener('click',()=>{
    if(chopsticksCount>1){chopsticksCount--; document.getElementById('chopsticks-qty').value=chopsticksCount;}
  });

  document.getElementById('send-order').addEventListener('click',sendOrder);

  window.onGoogleLibraryLoad=function(){google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID,callback:handleGoogleSignIn});google.accounts.id.renderButton(document.getElementById('profile-btn'),{theme:'filled_blue',size:'large',text:'signin_with',type:'standard'});}
});

// ================== FUNCTIONS ==================
function handleGoogleSignIn(response){
  currentUser=jwt_decode(response.credential);
  document.getElementById('profile-btn').textContent=currentUser.name;
}

function updateSummary(){
  let txt='סיכום הזמנה:\n';
  for(const id in selectedRolls){
    if(selectedRolls[id]>0){
      txt+=`${id} x${selectedRolls[id]}\n`;
    }
  }
  txt+=`צ'ופסטיקס: ${chopsticksCount}\n`;
  txt+=`רטבים: 2 חינם לכל רול\n`;
  const time=document.getElementById('pickup-time').value;
  if(time) txt+=`שעת איסוף: ${time}\n`;
  const notes=document.getElementById('notes').value;
  if(notes) txt+=`הערות: ${notes}\n`;
  document.getElementById('order-summary').textContent=txt;
}

async function sendOrder(){
  if(!currentUser){document.getElementById('messages').textContent='יש להתחבר עם חשבון גוגל לפני שליחה';return;}
  if(Object.keys(selectedRolls).length===0){document.getElementById('messages').textContent='בחר לפחות רול אחד לפני שליחה';return;}
  const time=document.getElementById('pickup-time').value;
  if(!time){document.getElementById('messages').textContent='בחר שעת איסוף לפני שליחה';return;}
  const notes=document.getElementById('notes').value;
  const order={user:currentUser.name,email:currentUser.email,rolls:selectedRolls,chopsticks:chopsticksCount,time,notes};
  try{
    await fetch(MAKE_WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(order)});
    document.getElementById('messages').textContent='ההזמנה נשלחה בהצלחה!';
  }catch(e){document.getElementById('messages').textContent='שגיאה בשליחת ההזמנה, נסה שוב.';}
}
</script>

</body>
</html>
