<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sushi Shifu</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

  <style>
    /* === ××™×¤×•×¡ ×•×¢×™×¦×•×‘ ×‘×¡×™×¡×™ === */
    * {
      box-sizing: border-box;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #1f1a1a, #0d0d0d);
      direction: rtl;
      color: #cb7e3d;
      font-size: 16px;
    }

    /* ×”×§×•× ×˜×™×™× ×¨ ×”×¨××©×™ */
    .container {
      max-width: 1020px;
      margin: 0 auto;
      background: #1a1a1a;
      min-height: 100vh;
      padding-bottom: 120px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* === ×›×•×ª×¨×ª === */
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      position: relative;
    }

    .logo {
      height: 120px;
      width: auto;
      border-radius: 8px;
      display: block;
      margin: 10px 0;
    }

    .user-buttons {
      position: absolute;
      top: 15px;
      left: 15px; 
      z-index: 50;
    }

    h1 {
      margin: 5px 0 15px 0;
      font-size: 1.6rem;
      text-align: center;
      color: #f5f5f5;
    }

    /* === ×˜××‘×™× (×©×•×¨×” ××—×ª × ×’×œ×œ×ª) === */
    .tabs {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #1a1a1a;
      display: flex;
      flex-wrap: nowrap;      /* ××•× ×¢ ×™×¨×™×“×ª ×©×•×¨×” */
      overflow-x: auto;       /* ×××¤×©×¨ ×’×œ×™×œ×” */
      white-space: nowrap;
      gap: 10px;
      padding: 10px 15px;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
    }
    
    .tabs::-webkit-scrollbar { display: none; } /* ×”×¡×ª×¨×ª ×¤×¡ ×’×œ×™×œ×” */

    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: #3a3a3a;
      color: #b0b0b0;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.95rem;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: #cb7e3d;
      color: #fff;
      font-weight: 700;
      box-shadow: 0 0 10px rgba(203, 126, 61, 0.4);
    }

    /* === ×›×¨×˜×™×¡×™ ×ª×¤×¨×™×˜ === */
    .menu-category {
        /* ×‘×¨×™×¨×ª ××—×“×œ ××•×¡×ª×¨ - ×—×•×¥ ××”×¨××©×•×Ÿ */
        display: none; 
        animation: fadeIn 0.3s ease;
        padding: 0 10px;
    }

    .category-title {
      color: #cb7e3d;
      font-size: 1.4rem;
      margin: 10px 5px 15px 0;
      font-weight: bold;
      border-right: 4px solid #cb7e3d;
      padding-right: 10px;
    }

    .category-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .roll-card {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      background: #252525;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      gap: 12px;
    }

    .roll-card-content {
      display: flex;
      flex: 1;
      align-items: center;
      gap: 15px;
    }

    .roll-card img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .roll-card .info {
      display: flex;
      flex-direction: column;
    }

    .roll-card h3 {
      margin: 0;
      color: #adb745;
      font-size: 1.15rem;
    }
    .roll-card p {
      margin: 2px 0;
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.3;
    }

    /* ×›×¤×ª×•×¨×™ ×›××•×ª */
    .quantity-control {
      display: flex;
      align-items: center;
      gap: 5px;
      background: #333;
      padding: 4px;
      border-radius: 8px;
    }
    .quantity-control button {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      border: none;
      background: #555;
      color: white;
      font-size: 1.2rem;
    }
    .quantity-control input {
      width: 30px;
      text-align: center;
      border: none;
      background: transparent;
      color: white;
      font-size: 1.1rem;
    }

    /* ××•×‘×™×™×œ */
    @media (max-width: 600px) {
      .roll-card { flex-direction: column; align-items: stretch; }
      .quantity-control { align-self: flex-end; margin-top: 5px; }
    }

    /* === ×˜×¤×¡×™× ×•×›×¤×ª×•×¨×™× === */
    #notes, #pickup-time {
      width: 100%;
      padding: 14px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #2a2a2a;
      color: #adb754;
      font-size: 1rem;
      margin-top: 10px;
    }

    #order-summary {
      background: #222;
      color: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
      margin-top: 15px;
      border: 1px dashed #444;
    }

    #send-order {
      margin-top: 20px;
      padding: 16px;
      background: #cb7e3d;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.3rem;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
    }
    #send-order:disabled { background: #555; opacity: 0.6; }

    /* === ×¤×•×¤-××¤ === */
    .order-popup {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 9999;
      display: flex; align-items: center; justify-content: center;
    }
    .order-popup__box {
      background: #fff; color: #000;
      padding: 30px; border-radius: 12px;
      text-align: center; max-width: 350px; width: 90%;
    }
    
    /* ××•×“×œ ×ª××•× ×” */
    #image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; }
    @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    
    /* ×›×¤×ª×•×¨ ×¤×¨×•×¤×™×œ */
    #profile-btn { border: 1px solid #cb7e3d; color: #cb7e3d; background:none; padding: 5px 10px; border-radius: 15px; }
  </style>
</head>
<body>

<div class="container">
  
  <header>
    <div class="user-buttons">
      <div id="login-btn"></div>
      <button id="profile-btn" style="display:none;">ğŸ‘¤ ×”×¤×¨×•×¤×™×œ ×©×œ×™</button>
    </div>
    <img src="https://i.imgur.com/m6KeXAB.jpeg" alt="×œ×•×’×•" class="logo">
    <h1>×ª×¤×¨×™×˜ â€” Sushi Shifu</h1>
  </header>

  <nav class="tabs">
    <button class="tab-btn active" onclick="switchTab('insideout', this)">Inside-out</button>
    <button class="tab-btn" onclick="switchTab('maki', this)">Maki</button>
    <button class="tab-btn" onclick="switchTab('onigiri', this)">Onigiri</button>
    <button class="tab-btn" onclick="switchTab('oshizushi', this)">Oshizushi</button>
    <button class="tab-btn" onclick="switchTab('poke', this)">Poke</button>
    <button class="tab-btn" onclick="switchTab('sauces', this)">×¨×˜×‘×™×</button>
  </nav>

  <main id="main-content">
    
    <div id="insideout" class="menu-category" style="display:block;">
      <div class="category-title">Inside-out Rolls</div>
      <div id="insideout-rolls" class="category-container"></div>
    </div>

    <div id="maki" class="menu-category">
      <div class="category-title">Maki Rolls</div>
      <div id="maki-rolls" class="category-container"></div>
    </div>

    <div id="onigiri" class="menu-category">
      <div class="category-title">Onigiri</div>
      <div id="onigiri-rolls" class="category-container"></div>
    </div>

    <div id="oshizushi" class="menu-category">
      <div class="category-title">Oshizushi</div>
      <div id="oshizushi-rolls" class="category-container"></div>
    </div>

    <div id="poke" class="menu-category">
      <div class="category-title">Poke</div>
      <div id="poke-rolls" class="category-container"></div>
    </div>

    <div id="sauces" class="menu-category">
      <div class="category-title">×¨×˜×‘×™×</div>
      <div id="sauces-container" class="category-container"></div>
      <p class="note" style="padding:0 10px;">×›×œ ×¨×•×œ ××§×‘×œ 2 ×¨×˜×‘×™× ×—×™× ×. ×¨×•×˜×‘ × ×•×¡×£ ×¢×•×œ×” 3â‚ª.</p>
    </div>

    <hr style="border:0; border-top:1px solid #333; margin:20px 0;">

    <div style="padding:0 15px;">
      <h3 style="color:#cb7e3d; margin-bottom:10px;">ğŸ¥¢ ×¦'×•×¤×¡×˜×™×§×¡</h3>
      <div class="quantity-control" style="background:none;">
        <button id="chopsticks-minus">âˆ’</button>
        <input id="chopsticks-qty" type="number" readonly value="1" style="border:1px solid #444; color:#cb7e3d;">
        <button id="chopsticks-plus">+</button>
      </div>

      <h3 style="color:#cb7e3d; margin-top:20px; margin-bottom:10px;">ğŸ“ ×”×¢×¨×•×ª ××™×©×™×•×ª</h3>
      <textarea id="notes" placeholder="×œ××©×œ: ×‘×¨×•×œ × ×™×•×˜×•×Ÿ, ×œ×œ× ×¨×•×˜×‘ ×‘×•×˜× ×™×..." oninput="updateSummary()"></textarea>

      <h3 style="color:#cb7e3d; margin-top:20px; margin-bottom:10px;">â° ×©×¢×ª ××™×¡×•×£</h3>
      <select id="pickup-time" onchange="updateSummary()">
        <option value="">×‘×—×¨ ×©×¢×”</option>
      </select>

      <h3 style="color:#cb7e3d; margin-top:20px; margin-bottom:10px;">ğŸ›’ ×¡×™×›×•× ×”×–×× ×”</h3>
      <pre id="order-summary">×”×–×× ×” ×¨×™×§×”...</pre>
      <button id="send-order" disabled>×©×œ×— ×”×–×× ×”</button>
      <div id="messages"></div>
    </div>

  </main>

  <div id="profile-page" style="display:none; padding:15px;">
    <h2 style="color:#cb7e3d;">ğŸ‘¤ ×”×¤×¨×•×¤×™×œ ×©×œ×™</h2>
    <div style="background:#252525; padding:20px; border-radius:10px; color:white;">
       <p><strong>×©×:</strong> <span id="p-name"></span></p>
       <p><strong>×˜×œ×¤×•×Ÿ:</strong> <span id="p-phone"></span></p>
    </div>
    <div style="margin-top:20px; text-align:center;">
       <button onclick="document.getElementById('profile-page').style.display='none'; document.getElementById('main-content').style.display='block';" style="padding:10px; background:#cb7e3d; border:none; color:white; border-radius:5px;">×—×–×•×¨ ×œ×ª×¤×¨×™×˜</button>
    </div>
  </div>

</div>

<div id="image-modal" onclick="this.style.display='none'">
    <div style="position:relative;">
        <img id="modal-img-src" src="" style="max-width:90vw; max-height:80vh; border-radius:10px;">
        <p id="modal-img-title" style="color:white; text-align:center; font-size:1.2rem; margin-top:10px;"></p>
    </div>
</div>

<div id="order-popup" class="order-popup" style="display:none">
  <div class="order-popup__box">
    <img src="https://i.imgur.com/m6KeXAB.jpeg" alt="" style="width:100px; margin-bottom:10px;">
    <h2 style="margin:0 0 10px 0;">×©×™××• ×œ×‘!</h2>
    <p id="order-popup-msg" style="margin-bottom:20px; font-size:1.1rem; line-height:1.4;"></p>
    <button onclick="document.getElementById('order-popup').style.display='none'" style="background:#cb7e3d; color:white; border:none; padding:10px 30px; border-radius:6px; font-size:1rem; cursor:pointer;">××™×©×•×¨</button>
  </div>
</div>

<script>
// --- ×”×’×“×¨×•×ª ---
const SUPABASE_URL = 'https://oxjokdjwdvmmdtcvqvon.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9rZGp3ZHZtbWR0Y3Zxdm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzgwMzMsImV4cCI6MjA3NDY1NDAzM30.DmKp79UiPi9iOU50UutevdqRcPyREMUJ7NT5ZmBHDsg';
const GOOGLE_CLIENT_ID = "962297663657-7bsrugivo5rjbu534lamiuc256gbqoc4.apps.googleusercontent.com";
const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/asitqrbtyjum10ph3vf6gxhkd766us3r";

let supabase, currentUser;
let orderItems = {}, sauceSelections = {}, chopsticksCount = 1;

// --- × ×ª×•× ×™× ---
const menuData = {
  insideout: [
    {name: '×¨×•×œ ×‘×™× ×’×•', desc: '×¡×œ××•×Ÿ × ×, ×©×× ×ª, ××‘×•×§×“×• ×‘×¦×™×¤×•×™ ×©×•××©×•× ×§×œ×•×™', price: 50, image_url: 'https://i.imgur.com/u5ebtHM.jpeg'},
    {name: '×¨×•×œ ×œ×•× ×”', desc: '×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ××¤×•×™ ×¢×œ ×¨×•×œ ×‘×˜×˜×”, ××‘×•×§×“×• ×•×©×™×˜××§×™', price: 50},
    {name: '×¨×•×œ ×¨×™×™', desc: '×˜×¨×˜×¨ ×¡×¤×™×™×¡×™ ×˜×•× ×” × × ×¢×œ ×¨×•×œ ××œ×¤×¤×•×Ÿ, ×¢×™×¨×™×ª ×•××•×©×™× ×§×•', price: 55},
    {name: '×¨×•×œ ×§×¨×™×™×–×™ ×‘×¨×•× ×•', desc: '×“×’ ×œ×‘×Ÿ, ×˜×•× ×”, ×¡×œ××•×Ÿ ×‘×¦×™×¤×•×™ ×©×•××©×•× ×§×œ×•×™', price: 60, image_url: 'https://i.imgur.com/rA4q1ND.jpeg'},
    {name: '×¨×•×œ ×”××¤×™ ×‘×¨×•× ×•', desc: '×¡×œ××•×Ÿ ×‘×¦×™×¤×•×™ ×©×§×“×™× ×§×œ×•×™×™× ×•×¨×•×˜×‘ ×˜×¨×™××§×™', price: 60, image_url: 'https://i.imgur.com/E3Uk19o.jpeg'},
    {name: '×¨×•×œ ××™×œ×”', desc: '×‘×˜×˜×”, ×¢×™×¨×™×ª ×•××‘×•×§×“×• ×‘×¢×™×˜×•×£ ×¡×œ××•×Ÿ ×¦×¨×•×‘', price: 50, image_url: 'https://i.imgur.com/UBhaUta.jpeg' },
    {name: '×¨×•×œ × ×™×•×˜×•×Ÿ', desc: '×˜×•× ×” ××“×•××”, ××‘×•×§×“×•, ×‘×˜×˜×” ×‘×¦×™×¤×•×™ ×¤× ×§×• ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 55, image_url: 'https://i.imgur.com/1fklsx4.jpeg'},
    {name: '×¨×•×œ ××•×œ×™', desc: '×“×’ ×œ×‘×Ÿ, ××œ×¤×¤×•×Ÿ, ××‘×•×§×“×• ×‘×¦×™×¤×•×™ ×©×•××©×•×', price: 50},
    {name: '×¨×•×œ ××™×œ×™', desc: '××§×œ ×¡×•×¨×™××™, ×“×’ ×œ×‘×Ÿ ××¤×•×™, ××•×©×™× ×§×• ×‘×¦×™×¤×•×™ ×¤× ×§×•', price: 50},
    {name: '×¨×•×œ ×¡×§××¨', desc: '×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ××¤×•×™ ×¢× ××‘×•×§×“×•, ××œ×¤×¤×•×Ÿ ×•×‘×˜×˜×” ×‘×¢×™×˜×•×¨ ××™×•× ×– ×•×¦\'×™×¤×¡', price: 50},
    {name: '×¨×•×œ ××’×™ ğŸŒ±', desc: '××œ×¤×¤×•×Ÿ, ×‘×˜×˜×”, ×¢×™×¨×™×ª ×•××‘×•×§×“×• ×‘×¢×™×˜×•×¨ ×‘×˜×˜×” ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 40},
    {name: '×¨×•×œ ×§×™×™×œ×”', desc: '×¡×œ××•×Ÿ × ×, ×§× ×¤×™×•, ×‘×˜×˜×” ×‘×¢×™×˜×•×£ ×©×‘×‘×™ ×¤× ×§×• ×¡×’×•×œ', price: 50},
    {name: '×¨×•×œ ×˜×™×™×¡×•×Ÿ', desc: '×¨×•×œ ××˜×•×’×Ÿ! ×¡×œ××•×Ÿ, ×‘×˜×˜×” ×•××œ×¤×¤×•×Ÿ ×‘×¦×™×¤×•×™ ×§×¨×™×¡×¤×™ ×•×¨×•×˜×‘ ×˜×¨×™××§×™', price: 60},
    {name: '×¨×•×œ ×œ×•×¡×™', desc: '×¡×œ××•×Ÿ × ×, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™ ×•××•×©×™× ×§×• ×‘×¦×™×¤×•×™ ×˜×•×‘×™×§×•', price: 55},
    {name: '×¨×•×œ ×‘×™×œ×™', desc: '×“×’ ×œ×‘×Ÿ ×¦×¨×•×‘, ×¢×™×¨×™×ª, ×‘×˜×˜×” ××¦×•×¤×” ×‘×¤× ×§×•', price: 50, image_url: 'https://i.imgur.com/AdT2Ync.jpeg'},
    {name: '×¨×•×œ ×œ××§×™', desc: '×˜×¨×˜×¨ ×¡×¤×™×™×¡×™ ×¡×œ××•×Ÿ ×¢× ××‘×•×§×“×•, ××œ×¤×¤×•×Ÿ ×•×¢×™×¨×™×ª', price: 50}
  ],
  maki: [
    {name: '×¨×•×œ ××œ×¤×™', desc: '×××§×™ ×¡×œ××•×Ÿ', price: 35},
    {name: '×¨×•×œ ××™×™ ××™×™ ğŸŒ±', desc: '×××§×™ ×‘×˜×˜×” ×•××‘×•×§×“×•', price: 25},
    {name: '×¨×•×œ ×¡× ×•×¤×™ ğŸŒ±', desc: '×××§×™ ××•×©×™× ×§×• ×•×§× ×¤×™×•', price: 25}
  ],
  onigiri: [
    {name: '××•× ×™×’×™×¨×™ ×¨×•×§×™', desc: '×˜×¨×˜×¨ ×˜×•× ×” ××“×•××” ×¢× ×¡×¤×™×™×¡×™ ××™×•× ×– ×•×‘×¦×œ ×™×¨×•×§', price: 35, image_url:'https://i.imgur.com/VW9Iexm.jpeg'},
    {name: '××•× ×™×’×™×¨×™ ×’\'×•× ×™', desc: '×˜×¨×˜×¨ ×¡×œ××•×Ÿ ×¢× ×¡×¤×™×™×¡×™ ××™×•× ×– ×•×‘×¦×œ ×™×¨×•×§', price: 30, image_url:'https://i.imgur.com/VW9Iexm.jpeg'},
    {name: '××•× ×™×’×™×¨×™ ×’\'×™×–×œ ğŸŒ±', desc: '××‘×•×§×“×• ×•×‘×˜×˜×”', price: 25 , image_url:'https://i.imgur.com/VW9Iexm.jpeg'}
  ],
  oshizushi: [
    {name: '××•×©×™×–×•×©×™ ×¡×œ××•×Ÿ ×§×œ××¡×™', desc: '6 ×™×—\' - ×©×›×‘×ª ×¡×œ××•×Ÿ ×˜×¨×™ ×•×©×›×‘×ª ××‘×•×§×“×• ×œ×—×•×¦×™× ×‘×™×Ÿ ×©×›×‘×•×ª ××•×¨×– ×¡×•×©×™', price: 50},
    {name: '××•×©×™×–×•×©×™ ×˜×•× ×” ×¤×™×§× ×˜×™', desc: '6 ×™×—\' - ×©×›×‘×ª ×˜×•× ×” ××“×•××” ×•×©×›×‘×ª ×‘×˜×˜×” ×œ×—×•×¦×™× ×‘×™×Ÿ ×©×›×‘×•×ª ××•×¨×– ×¡×•×©×™', price: 55},
    {name: '××•×©×™×–×•×©×™ ×¦××—×•× ×™ ğŸŒ±', desc: '6  ×™×—\' - ×©×›×‘×ª ××‘×•×§×“×• ×•×©×›×‘×ª ×‘×˜×˜×” ×œ×—×•×¦×™× ×‘×™×Ÿ ×©×›×‘×•×ª ××•×¨×– ×¡×•×©×™ ', price: 40}
  ],
  poke: [
    {name: '×‘×•×œ-×“×•×’', desc: '××•×¨×– ×¡×•×©×™, ×¡×œ××•×Ÿ ×‘××¨×™× ×“×”, ××“×××”, ××œ×¤×¤×•×Ÿ, ××‘×•×§×“×•, ×‘×¦×œ ×™×¨×•×§. ××¢×œ ×©×•××©×•× ×•×¨×•×˜×‘ ×¡×¤×™×™×¡×™ ××™×•× ×–', price: 60, image_url:'https://i.imgur.com/cUf6gYx.jpeg'},
    {name: '×¤×™×˜-×‘×•×œ', desc: '××•×¨×– ×¡×•×©×™, ×˜×•× ×” ×‘××¨×™× ×“×”, ××“×××”, ×× ×’×•, ×›×¨×•×‘ ×¡×’×•×œ. ××¢×œ ×‘×¦×œ ×©××œ×•×˜ ××˜×•×’×Ÿ ×•×¨×•×˜×‘ ×¦×³×™×œ×™ ×× × ×¡ ××ª×•×§', price: 70, image_url:'https://i.imgur.com/DhFRUGl.jpeg'},
    {name: '×‘×•×œ-×˜×¨×™×™×¨ ğŸŒ±', desc: '××•×¨×– ×¡×•×©×™, ××“×××”, ××œ×¤×¤×•×Ÿ, ×¤×˜×¨×™×•×ª ×©×™×˜××§×™, ×’×–×¨ ×•××‘×•×§×“×•. ××¢×œ ×©×•××©×•× ×•×¨×•×˜×‘ ×‘×•×˜× ×™×', price: 45, image_url:'https://i.imgur.com/GvXgFPY.jpeg'}
  ],
  sauces: [
    {name: '×¡×¤×™×™×¡×™ ××™×•× ×–', price: 0},
    {name: '×¨×•×˜×‘ ×¡×•×™×”', price: 0},
    {name: '×¨×•×˜×‘ ×˜×¨×™××§×™', price: 0},
    {name: '×’\'×™× ×’\'×¨', price: 0},
    {name: '×•×•××¡×‘×™', price: 0}
  ]
};

// --- ××ª×—×•×œ ---
document.addEventListener('DOMContentLoaded', () => {
  if (typeof window.supabase !== 'undefined') supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 1. ×¦×™×•×¨ ×”×ª×¤×¨×™×˜
  renderMenu();
  
  // 2. ××ª×—×•×œ ×’×•×’×œ ×•×©×¢×•×ª
  initGoogleAuth();
  generatePickupSlots();
  setupChopsticks();
  setupSendOrder();
  
  // 3. ×‘×“×™×§×ª ××©×ª××© ××§×•××™
  const stored = localStorage.getItem('sushiUser');
  if(stored) { currentUser = JSON.parse(stored); updateUI(); }
  
  // 4. ×‘×“×™×§×ª ×™×•× (×¤×•×¤-××¤)
  const isWednesday = new Date().getDay() === 3;
  if(!isWednesday) {
    document.getElementById('order-popup-msg').innerHTML = "×”×”×–×× ×•×ª ×¤×ª×•×—×•×ª ×‘×™××™ ×¨×‘×™×¢×™ ×‘×œ×‘×“.<br>× ×™×ª×Ÿ ×œ×¦×¤×•×ª ×‘×ª×¤×¨×™×˜ ××š ×œ× ×œ×©×œ×•×— ×”×–×× ×”.";
    document.getElementById('order-popup').style.display = 'flex';
  }
});

// --- ×¤×•× ×§×¦×™×•×ª ---

// ×”×—×œ×¤×ª ×˜××‘×™×
window.switchTab = function(tabId, btn) {
    // ×”×¡×ª×¨×ª ×›×œ ×”×§×˜×’×•×¨×™×•×ª
    document.querySelectorAll('.menu-category').forEach(el => el.style.display = 'none');
    // ×”×¦×’×ª ×”×§×˜×’×•×¨×™×” ×©× ×‘×—×¨×”
    document.getElementById(tabId).style.display = 'block';
    
    // ×”×—×œ×¤×ª ×›×¤×ª×•×¨ ×¤×¢×™×œ
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // ×’×œ×™×œ×” ×œ××¢×œ×”
    window.scrollTo({top:0, behavior:'smooth'});
};

// ×¦×™×•×¨ ×ª×¤×¨×™×˜
function renderMenu() {
    Object.keys(menuData).forEach(cat => {
        if(cat === 'sauces') {
             // ×¨×˜×‘×™×
             document.getElementById('sauces-container').innerHTML = menuData.sauces.map((item,i) => `
                <div class="roll-card">
                  <div class="roll-card-content">
                    <div class="info"><h3>${item.name}</h3></div>
                  </div>
                  <div class="quantity-control">
                     <button onclick="changeItem('sauce_${i}', -1)">-</button>
                     <input id="sauce_${i}" value="0" readonly>
                     <button onclick="changeItem('sauce_${i}', 1)">+</button>
                  </div>
                </div>
             `).join('');
        } else {
             // ×¨×•×œ×™×
             document.getElementById(cat + '-rolls').innerHTML = menuData[cat].map((item,i) => `
                <div class="roll-card">
                   <div class="roll-card-content">
                     ${item.image_url ? `<img src="${item.image_url}" onclick="showImg('${item.image_url}','${item.name}')">` : '<div class="roll-image-placeholder">ğŸ£</div>'}
                     <div class="info">
                        <h3>${item.name}</h3>
                        <p>${item.desc}</p>
                        <p style="color:#cb7e3d; font-weight:bold;">${item.price}â‚ª</p>
                     </div>
                   </div>
                   <div class="quantity-control">
                     <button onclick="changeItem('${cat}_${i}', -1)">-</button>
                     <input id="${cat}_${i}" value="0" readonly>
                     <button onclick="changeItem('${cat}_${i}', 1)">+</button>
                   </div>
                </div>
             `).join('');
        }
    });
}

// × ×™×”×•×œ ×›××•×™×•×ª
window.changeItem = function(id, delta) {
    const el = document.getElementById(id);
    let val = parseInt(el.value) || 0;
    val = Math.max(0, val + delta);
    el.value = val;
    
    // ×¢×“×›×•×Ÿ ××•×‘×™×™×§×˜ ×”×”×–×× ×”
    if(id.startsWith('sauce')) {
        if(val > 0) sauceSelections[id] = val; else delete sauceSelections[id];
    } else {
        if(val > 0) orderItems[id] = val; else delete orderItems[id];
    }
    updateSummary();
};

window.showImg = (url, title) => {
    document.getElementById('modal-img-src').src = url;
    document.getElementById('modal-img-title').innerText = title;
    document.getElementById('image-modal').style.display = 'flex';
}

function setupChopsticks() {
    document.getElementById('chopsticks-minus').onclick = () => { if(chopsticksCount>0) chopsticksCount--; document.getElementById('chopsticks-qty').value=chopsticksCount; updateSummary(); };
    document.getElementById('chopsticks-plus').onclick = () => { chopsticksCount++; document.getElementById('chopsticks-qty').value=chopsticksCount; updateSummary(); };
}

function updateSummary() {
    let total = 0, count = 0, txt = "";
    
    // ×¨×•×œ×™×
    for(let k in orderItems) {
        const [cat, idx] = k.split('_');
        const item = menuData[cat][idx];
        const qty = orderItems[k];
        txt += `${item.name} x${qty} = ${item.price*qty}â‚ª\n`;
        total += item.price*qty;
        count += qty;
    }
    
    // ×¨×˜×‘×™×
    let sCount = 0;
    for(let k in sauceSelections) sCount += sauceSelections[k];
    const free = count * 2;
    const extra = Math.max(0, sCount - free);
    if(sCount > 0) {
        txt += `\n×¨×˜×‘×™×: ${sCount} (${free} ×—×™× ×)\n×ª×•×¡×¤×ª: ${extra*3}â‚ª\n`;
        total += extra*3;
    }
    
    txt += `\n×¡×”"×›: ${total}â‚ª`;
    document.getElementById('order-summary').textContent = count ? txt : "×”×–×× ×” ×¨×™×§×”...";
    
    const btn = document.getElementById('send-order');
    const time = document.getElementById('pickup-time').value;
    if(count > 0 && time) { btn.disabled=false; btn.style.opacity=1; } else { btn.disabled=true; btn.style.opacity=0.6; }
}

function generatePickupSlots() {
    const sel = document.getElementById('pickup-time');
    for(let h=19; h<=22; h++) {
        for(let m=0; m<60; m+=15) {
            if(h==22 && m>30) continue;
            let t = `${h}:${m<10?'0'+m:m}`;
            sel.innerHTML += `<option value="${t}">${t}</option>`;
        }
    }
}

// ×©×œ×™×—×”
function setupSendOrder() {
    document.getElementById('send-order').onclick = async () => {
        if(!currentUser) { alert('×× × ×”×ª×—×‘×¨'); initGoogleAuth(); return; }
        
        const btn = document.getElementById('send-order');
        btn.textContent = '×©×•×œ×—...';
        
        const orderData = {
            user_name: currentUser.name,
            email: currentUser.email,
            phone: currentUser.phone,
            order_date: new Date().toISOString().split('T')[0],
            pickup_time: document.getElementById('pickup-time').value,
            items: JSON.stringify(orderItems),
            sauces: JSON.stringify(sauceSelections),
            chopsticks: chopsticksCount,
            notes: document.getElementById('notes').value,
            total_price: parseInt(document.getElementById('order-summary').textContent.split('×¡×”"×›: ')[1])
        };
        
        // Supabase Insert
        if(supabase) await supabase.from('Sushi').insert([orderData]);
        
        // Make Webhook
        fetch(MAKE_WEBHOOK_URL, { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(orderData) });
        
        document.getElementById('messages').innerHTML = "<span style='color:green'>×”×”×–×× ×” × ×©×œ×—×”!</span>";
        setTimeout(() => location.reload(), 2000);
    };
}

// ×’×•×’×œ ×•×¤×¨×•×¤×™×œ
function initGoogleAuth() {
    if(!window.google?.accounts?.id) return setTimeout(initGoogleAuth, 500);
    window.google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleLogin });
    window.google.accounts.id.renderButton(document.getElementById('login-btn'), {theme:'filled_black', text:'signin'});
}

function handleLogin(res) {
    const dec = jwt_decode(res.credential);
    currentUser = { name: dec.name, email: dec.email, picture: dec.picture, phone: '' };
    // ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×ª ×˜×œ×¤×•×Ÿ ×× ×¨×•×¦×™×
    localStorage.setItem('sushiUser', JSON.stringify(currentUser));
    updateUI();
}

function updateUI() {
    document.getElementById('login-btn').style.display='none';
    document.getElementById('profile-btn').style.display='inline-block';
    
    // ×¤×¨×•×¤×™×œ
    document.getElementById('p-name').textContent = currentUser.name;
    document.getElementById('p-phone').textContent = currentUser.phone || '×œ× ×”×•×–×Ÿ';
    
    document.getElementById('profile-btn').onclick = () => {
        document.getElementById('main-content').style.display='none';
        document.getElementById('profile-page').style.display='block';
    };
}
</script>
</body>
</html>
