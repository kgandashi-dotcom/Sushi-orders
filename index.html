<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>סושי דיל</title>
<style>
:root {
    --accent:#7a2a2a;
    --accent-dark:#5e1b1b;
    --bg:#fff;
    --danger:#d9534f;
}
*{box-sizing:border-box;}
body{margin:0;font-family: Arial, Helvetica, sans-serif; background: linear-gradient(180deg,#f6f5f4, #efecec); color:#222; direction: rtl;}
header{display:flex; flex-direction:column; align-items:center; gap:12px; padding:12px;}
.logo{width:120px; border-radius:10px;}
.auth-container{align-self:flex-start; display:flex; gap:8px;}
.auth-container .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;}
.auth-container .btn.primary{background:var(--accent);color:#fff;}
.auth-container .btn.secondary{background:#fff;color:var(--accent);border:1px solid #ddd;}
.menu-tabs{display:flex; gap:8px; flex-wrap:wrap; justify-content:center;}
.menu-tabs .tab{padding:8px 12px;border-radius:8px;background:#fff;border:1px solid #eee;cursor:pointer;font-weight:700;}
.menu-tabs .tab.active{background:var(--accent);color:#fff;border-color:var(--accent-dark);}
main{display:flex; flex-direction:column; gap:18px; padding:0 12px;}
#menu-area{display:flex; flex-direction:column; gap:12px;}
.category-container{display:flex; flex-direction:column; gap:10px; padding:6px 0;}
.roll-card{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-radius:10px; background:var(--bg); box-shadow:0 4px 14px rgba(0,0,0,0.05);}
.roll-card .info{flex:1;}
.roll-card h3{margin:0;color:var(--accent); font-size:1rem;}
.roll-card p{margin:0;font-size:0.9rem;color:#444;}
.quantity-control{display:flex; gap:6px;}
.quantity-control button{width:36px;height:36px;border-radius:8px;border:none;background:#f0c0c0;color:var(--accent); font-weight:700;font-size:1.2rem;cursor:pointer;}
.quantity-control input{width:50px;text-align:center;border:1px solid #ddd;border-radius:6px;padding:4px;}
aside{display:flex; flex-direction:column; gap:12px; margin-top:12px;}
.panel{background:#fff; padding:12px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,0.04);}
.panel-title{font-weight:800;color:var(--accent);margin-bottom:8px;}
#order-summary{background:#fafafa; padding:10px; border-radius:8px; min-height:120px; white-space:pre-wrap; font-family:"Courier New", monospace;}
.actions-row{display:flex; gap:8px; margin-top:8px;}
textarea#notes{width:100%; min-height:80px; padding:8px; border-radius:6px; border:1px solid #ddd; resize:vertical;}
.note{color:#6b6b6b;font-size:0.9rem;margin-top:8px;}
#messages{margin-top:8px;color:var(--danger); font-weight:700;}
@media(max-width:980px){
    main{flex-direction:column;}
    .auth-container{align-self:flex-start;}
}
</style>
</head>
<body>
<header>
    <img src="https://i.imgur.com/m6KeXAB.jpeg" alt="לוגו" class="logo">
    <div class="auth-container">
        <button id="profile-btn" class="btn secondary">פרופיל</button>
        <button id="auth-btn" class="btn primary">התחבר</button>
    </div>
    <nav class="menu-tabs" role="navigation" aria-label="תפריט קטגוריות">
        <button class="tab active" data-target="insideout-rolls">Inside-out</button>
        <button class="tab" data-target="maki-rolls">Maki</button>
        <button class="tab" data-target="onigiri-rolls">Onigiri</button>
        <button class="tab" data-target="poke-rolls">Poke</button>
        <button class="tab" data-target="oshizushi-rolls">Oshizushi</button>
    </nav>
</header>
<main>
<section id="menu-area">
    <div id="insideout-rolls" class="category-container"></div>
    <div id="maki-rolls" class="category-container" style="display:none;"></div>
    <div id="onigiri-rolls" class="category-container" style="display:none;"></div>
    <div id="poke-rolls" class="category-container" style="display:none;"></div>
    <div id="oshizushi-rolls" class="category-container" style="display:none;"></div>
</section>

<aside>
    <section class="panel">
        <div class="panel-title">רטבים</div>
        <div id="sauces-container" class="category-container"></div>
        <p class="note">כל רול מקבל 2 רטבים חינם. רוטב נוסף 3₪.</p>
    </section>
    <section class="panel">
        <div class="panel-title">כמות צ'ופסטיקס</div>
        <div class="quantity-control">
            <button id="chopsticks-minus">−</button>
            <input id="chopsticks-qty" type="number" readonly value="1">
            <button id="chopsticks-plus">+</button>
        </div>
    </section>
    <section class="panel">
        <div class="panel-title">בחר שעת איסוף</div>
        <select id="pickup-time"><option value="">בחר שעה</option></select>
    </section>
    <section class="panel">
        <div class="panel-title">הערות אישיות</div>
        <textarea id="notes" placeholder="לדוגמה: ללא גלוטן, הגעה בשער 3..."></textarea>
    </section>
    <section class="panel">
        <div class="panel-title">סיכום הזמנה</div>
        <pre id="order-summary">הזמנה ריקה — בחר רולים, רטבים ושעה להצגת הסיכום.</pre>
        <div class="actions-row">
            <button id="send-order" class="btn primary">שלח הזמנה</button>
        </div>
    </section>
    <div id="messages" aria-live="polite"></div>
</aside>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
<script>
/* CONFIG */
const SUPABASE_URL = 'https://oxjokdjwdvmmdtcvqvon.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9rZGp3ZHZtbWR0Y3Zxdm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzgwMzMsImV4cCI6MjA3NDY1NDAzM30.DmKp79UiPi9iOU50UutevdqRcPyREMUJ7NT5ZmBHDsg';
const GOOGLE_CLIENT_ID = '962297663657-7bsrugivo5rjbu534lamiuc256gbqoc4.apps.googleusercontent.com';
const MAKE_WEBHOOK_URL = 'https://hook.eu2.make.com/asitqrbtyjum10ph3vf6gxhkd766us3r';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* STORAGE / STATE */
let bookedTimes = JSON.parse(localStorage.getItem('bookedTimes')||'[]');
let dailyRollCount = JSON.parse(localStorage.getItem('dailyRollCount')||'{}');
let currentUser = JSON.parse(localStorage.getItem('currentUser')||'null');
let chopsticksCount = 1;
let selectedRolls = {};
let selectedSauces = {};

/* MENU DATA */
const insideOutRollsData = [
    {id:"bingo", name:"רול בינגו - 50₪", description:"סלמון נא, שמנת, אבוקדו בציפוי שומשום קלוי", price:50},
    {id:"luna", name:"רול לונה - 50₪", description:"ספייסי סלמון אפוי על רול בטטה, אבוקדו ושיטאקי", price:50},
    {id:"belgian", name:"רול ריי - 55₪", description:"טרטר ספייסי טונה נא על רול מלפפון, עירית ואושינקו", price:55},
    {id:"crazy-bruno", name:"רול קרייזי ברונו - 60₪", description:"דג לבן, טונה, סלמון בציפוי שומשום קלוי", price:60},
    {id:"happy-bruno", name:"רול האפי ברונו - 60₪", description:"סלמון בציפוי שקדים קלויים ורוטב טריאקי", price:60},
    {id:"mila", name:"רול מילה - 50₪", description:"בטטה, עירית ואבוקדו בעיטוף סלמון צרוב", price:50},
    {id:"newton", name:"רול ניוטון - 55₪", description:"טונה אדומה, אבוקדו, בטטה בציפוי פנקו ורוטב בוטנים", price:55},
    {id:"oli", name:"רול אולי - 50₪", description:"דג לבן, מלפפון, אבוקדו בציפוי שומשום", price:50},
    {id:"milli", name:"רול מילי - 50₪", description:"מקל סורימי, דג לבן אפוי, אושינקו בציפוי פנקו", price:50},
    {id:"scar", name:"רול סקאר - 50₪", description:"ספייסי סלמון אפוי עם אבוקדו, מלפפון ובטטה בעיטור מיונז וצ’יפס", price:50},
    {id:"magi", name:"רול מגי🌱 - 40₪", description:"מלפפון, בטטה, עירית ואבוקדו בעיטור בטטה ורוטב בוטנים", price:40},
    {id:"tyson", name:"רול טייסון וקיילה - 50₪", description:"סלמון נא, קנפיו, בטטה בעיטוף שבבי פנקו סגול", price:50},
    {id:"lucy", name:"רול לוסי - 55₪", description:"סלמון נא, פטריות שיטאקי ואושינקו בציפוי טוביקו", price:55},
    {id:"billy", name:"רול בילי - 50₪", description:"דג לבן צרוב, עירית, בטטה מצופה בפנקו", price:50},
    {id:"lucky", name:"רול לאקי - 50₪", description:"טרטר ספייסי סלמון עם אבוקדו, מלפפון ועירית", price:50}
];
const makiRollsData = [
    {id:"alfi", name:"רול אלפי - 35₪", description:"מאקי סלמון", price:35},
    {id:"maymay", name:"רול מיי מיי🌱 - 25₪", description:"מאקי בטטה ואבוקדו", price:25}
];
const onigiriRollsData = [
    {id:"salmon", name:"סלמון 🐟 - 28₪", description:"אוניגירי סלמון קלוי", price:28},
    {id:"tuna", name:"טונה 🐟 - 28₪", description:"אוניגירי טונה אפוי", price:28}
];
const pokeRollsData = [
    {id:"classic-poke", name:"פוקה קלאסי - 45₪", description:"אורז, סלמון נא, אבוקדו, ירקות טריים", price:45},
    {id:"spicy-tuna", name:"פוקה ספייסי טונה - 50₪", description:"טונה, מלפפון, אושינקו, ספייסי מיונז", price:50}
];
const oshizushiRollsData = [
    {id:"mango-salmon", name:"אושי מנגו סלמון - 55₪", description:"אושי עם סלמון ומנגו טרי", price:55},
    {id:"eel-avocado", name:"אושי סלמון אבוקדו - 55₪", description:"אושי עם סלמון אפוי ואבוקדו", price:55}
];
const saucesData = [
    {id:"soya", name:"סויה"},
    {id:"spicy-mayo", name:"ספייסי מיונז"},
    {id:"ginger-wasabi", name:"ג׳ינג׳ר וואסאבי"}
];
const categoriesMap = {
    "insideout-rolls": insideOutRollsData,
    "maki-rolls": makiRollsData,
    "onigiri-rolls": onigiriRollsData,
    "poke-rolls": pokeRollsData,
    "oshizushi-rolls": oshizushiRollsData
};

/* UI INIT */
function createRollCard(roll){
    const div = document.createElement('div');
    div.className = 'roll-card';
    div.innerHTML = `
        <div class="info">
            <h3>${roll.name}</h3>
            <p>${roll.description}</p>
        </div>
        <div class="quantity-control">
            <button class="minus">−</button>
            <input type="number" value="0" readonly>
            <button class="plus">+</button>
        </div>
    `;
    const input = div.querySelector('input');
    div.querySelector('.minus').addEventListener('click',()=>{
        if(parseInt(input.value)>0) input.value=parseInt(input.value)-1;
        selectedRolls[roll.id]=parseInt(input.value);
        updateSummary();
    });
    div.querySelector('.plus').addEventListener('click',()=>{
        input.value=parseInt(input.value)+1;
        selectedRolls[roll.id]=parseInt(input.value);
        updateSummary();
    });
    return div;
}
function createSauceCheckbox(sauce){
    const div = document.createElement('div');
    div.innerHTML = `<input type="checkbox" id="sauce-${sauce.id}"> <label for="sauce-${sauce.id}">${sauce.name}</label>`;
    div.querySelector('input').addEventListener('change',(e)=>{
        selectedSauces[sauce.id]=e.target.checked;
        updateSummary();
    });
    return div;
}

/* POPULATE MENU */
Object.keys(categoriesMap).forEach(catId=>{
    const container = document.getElementById(catId);
    categoriesMap[catId].forEach(roll=>{
        container.appendChild(createRollCard(roll));
    });
});
const saucesContainer = document.getElementById('sauces-container');
saucesData.forEach(sauce=>saucesContainer.appendChild(createSauceCheckbox(sauce)));

/* POPULATE PICKUP TIMES */
const pickupSelect = document.getElementById('pickup-time');
for(let h=19;h<=22;h++){
    for(let m=0;m<60;m+=30){
        let value = `${h}:${m===0?'00':m}`;
        pickupSelect.innerHTML += `<option value="${value}">${value}</option>`;
    }
}

/* TAB NAVIGATION */
document.querySelectorAll('.menu-tabs .tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
        document.querySelectorAll('.menu-tabs .tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        Object.keys(categoriesMap).forEach(catId=>{
            document.getElementById(catId).style.display='none';
        });
        document.getElementById(tab.dataset.target).style.display='flex';
    });
});

/* CHOPSTICKS */
document.getElementById('chopsticks-minus').addEventListener('click',()=>{
    if(chopsticksCount>1) chopsticksCount--;
    document.getElementById('chopsticks-qty').value=chopsticksCount;
    updateSummary();
});
document.getElementById('chopsticks-plus').addEventListener('click',()=>{
    chopsticksCount++;
    document.getElementById('chopsticks-qty').value=chopsticksCount;
    updateSummary();
});

/* SUMMARY */
function updateSummary(){
    let text='הזמנה ריקה — בחר רולים, רטבים ושעה להצגת הסיכום.';
    const rolls = Object.entries(selectedRolls).filter(([id,qty])=>qty>0);
    if(rolls.length>0){
        text='רולים:\n';
        rolls.forEach(([id,qty])=>{
            let rollData = [...insideOutRollsData,...makiRollsData,...onigiriRollsData,...pokeRollsData,...oshizushiRollsData].find(r=>r.id===id);
            text+=`- ${rollData.name} x${qty}\n`;
        });
    }
    const sauces = Object.entries(selectedSauces).filter(([id,sel])=>sel).map(([id])=>saucesData.find(s=>s.id===id).name);
    if(sauces.length>0) text+='\nרטבים: '+sauces.join(', ');
    text+='\n\nצ’ופסטיקס: '+chopsticksCount;
    text+='\nשעת איסוף: '+(pickupSelect.value||'-');
    text+='\nהערות: '+document.getElementById('notes').value;
    document.getElementById('order-summary').textContent=text;
}

/* AUTH */
let authToken=null;
const authBtn=document.getElementById('auth-btn');
const profileBtn=document.getElementById('profile-btn');

function signInWithGoogle(){
    const client = google.accounts.id;
    client.initialize({client_id:GOOGLE_CLIENT_ID, callback: handleGoogleSignIn});
    client.prompt();
}

function handleGoogleSignIn(response){
    const profile = jwt_decode(response.credential);
    currentUser = {email:profile.email, name:profile.name};
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    authToken=response.credential;
    profileBtn.textContent=currentUser.name;
    authBtn.style.display='none';
}

authBtn.addEventListener('click', signInWithGoogle);

/* SEND ORDER */
document.getElementById('send-order').addEventListener('click', async()=>{
    if(!currentUser){ document.getElementById('messages').textContent='יש להתחבר לפני שליחה!'; return; }
    const rolls = Object.entries(selectedRolls).filter(([id,qty])=>qty>0);
    if(rolls.length===0){ document.getElementById('messages').textContent='בחר רול אחד לפחות!'; return; }
    if(!pickupSelect.value){ document.getElementById('messages').textContent='בחר שעת איסוף!'; return; }

    const orderData={
        user:currentUser,
        rolls,
        sauces:Object.entries(selectedSauces).filter(([id,sel])=>sel).map(([id])=>id),
        chopsticks:chopsticksCount,
        pickupTime:pickupSelect.value,
        notes:document.getElementById('notes').value
    };

    try{
        await supabase.from('orders').insert([orderData]);
        await fetch(MAKE_WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(orderData)});
        document.getElementById('messages').textContent='ההזמנה נשלחה בהצלחה!';
        selectedRolls={}; selectedSauces={}; updateSummary();
        document.querySelectorAll('.quantity-control input').forEach(i=>i.value=0);
        document.querySelectorAll('#sauces-container input').forEach(i=>i.checked=false);
    }catch(e){
        console.error(e);
        document.getElementById('messages').textContent='שגיאה בשליחת ההזמנה';
    }
});
</script>
</body>
</html>
